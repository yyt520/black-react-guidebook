<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/black-react-guidebook/umi.b283d7b5.css" />
    <script>
      window.routerBase = "/black-react-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.20
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>源码分析</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/infrastructure/hooks/hooks-analysis" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/black-react-guidebook//">React Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/black-react-guidebook//foundation">基础</a></span><span><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure">架构</a></span><span><a href="/black-react-guidebook//ecosystem">生态</a></span><span><a href="/black-react-guidebook//api-reference">API</a></span><span><a href="/black-react-guidebook//extensions">扩展</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/black-react-guidebook//"></a><h1>React Guidebook</h1><p>React 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/black-react-guidebook//foundation">基础</a></li><li><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure">架构</a></li><li><a href="/black-react-guidebook//ecosystem">生态</a></li><li><a href="/black-react-guidebook//api-reference">API</a></li><li><a href="/black-react-guidebook//extensions">扩展</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">新版架构</a><ul><li><a href="/black-react-guidebook//infrastructure/new/fiber"><span>Fiber</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/reconciliation"><span>Reconciliation</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/concurrent"><span>Concurrent</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/scheduler"><span>Scheduler</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">Hooks</a><ul><li><a href="/black-react-guidebook//infrastructure/hooks"><span>Hooks</span></a></li><li><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis"><span>源码分析</span></a></li><li><a href="/black-react-guidebook//infrastructure/hooks/use-state"><span>useState</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">旧版架构</a><ul><li><a href="/black-react-guidebook//infrastructure/old/virtual-dom"><span>Virtual DOM</span></a></li><li><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm"><span>DOM DIFF 算法</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="前置知识" data-depth="2"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#前置知识"><span>前置知识</span></a></li><li title="函数组件和类组件" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#函数组件和类组件"><span>函数组件和类组件</span></a></li><li title="React Fiber" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#react-fiber"><span>React Fiber</span></a></li><li title="React 渲染器与 setState" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#react-渲染器与-setstate"><span>React 渲染器与 setState</span></a></li><li title="了解 useState" data-depth="2"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#了解-usestate"><span>了解 useState</span></a></li><li title="引入和触发更新" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#引入和触发更新"><span>引入和触发更新</span></a></li><li title="示例分析" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#示例分析"><span>示例分析</span></a></li><li title="核心步骤分析" data-depth="2"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#核心步骤分析"><span>核心步骤分析</span></a></li><li title="Hook 对象" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#hook-对象"><span>Hook 对象</span></a></li><li title="renderWithHooks" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#renderwithhooks"><span>renderWithHooks</span></a></li><li title="总结" data-depth="2"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#总结-1"><span>总结</span></a></li><li title="使用原则" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#使用原则"><span>使用原则</span></a></li><li title="为什么不能在循环/条件语句中执行" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#为什么不能在循环条件语句中执行"><span>为什么不能在循环/条件语句中执行</span></a></li><li title="为什么只能在函数组件中使用 hooks" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#为什么只能在函数组件中使用-hooks"><span>为什么只能在函数组件中使用 hooks</span></a></li><li title="useState 整体运作流程总结" data-depth="3"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#usestate-整体运作流程总结"><span>useState 整体运作流程总结</span></a></li><li title="参考资料" data-depth="2"><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#参考资料"><span>参考资料</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="源码分析"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#源码分析"><span class="icon icon-link"></span></a>源码分析</h1><p>从源码剖析 <code>useState</code> 的执行过程。</p><p>示例代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">import</span><span class="token plain"> React</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> useState </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token string">&#x27;./App.css&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">count</span><span class="token punctuation">,</span><span class="token plain"> setCount</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">,</span><span class="token plain"> setName</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&#x27;Star&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 调用三次setCount便于查看更新队列的情况</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">countPlusThree</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">className</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">App</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">{</span><span class="token plain">name</span><span class="token punctuation">}</span><span class="token plain"> Has Clicked </span><span class="token tag punctuation">&lt;</span><span class="token tag">strong</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">count</span><span class="token punctuation">}</span><span class="token tag punctuation">&lt;/</span><span class="token tag">strong</span><span class="token tag punctuation">&gt;</span><span class="token plain"> Times</span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">countPlusThree</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain">Click </span><span class="token operator">*</span><span class="token number">3</span><span class="token tag punctuation">&lt;/</span><span class="token tag">button</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>代码非常简单，点击 <code>button</code> 使 <code>count+3</code>，<code>count</code> 的值会显示在屏幕上。</p><h2 id="前置知识"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#前置知识"><span class="icon icon-link"></span></a>前置知识</h2><h3 id="函数组件和类组件"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#函数组件和类组件"><span class="icon icon-link"></span></a>函数组件和类组件</h3><blockquote><p>本节参考：<a target="_blank" rel="noopener noreferrer" href="https://overreacted.io/how-are-function-components-different-from-classes/">How Are Function Components Different from Classes?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><p>本节主要概念：</p><ul><li>函数组件和类组件的区别</li><li>React 如何区分这两种组件</li></ul><p>我们来看一个简单的 <code>Greeting</code> 组件，它支持定义成类和函数两种性质。在使用它时，不用关心他是如何定义的。</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// 是类还是函数 —— 无所谓</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Greeting</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"> </span><span class="token comment">// &lt;p&gt;Hello&lt;/p&gt;</span></div></pre></div><p>如果 <code>Greeting</code> 是一个函数，React 需要调用它：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Greeting.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">Greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain">Hello</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// React 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">Greeting</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// &lt;p&gt;Hello&lt;/p&gt;</span></div></pre></div><p>但如果 <code>Greeting</code> 是一个类，React 需要先将其实例化，再调用刚才生成实例的 <code>render</code> 方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Greeting.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Greeting</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain">Hello</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// React 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Greeting</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// Greeting {}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// &lt;p&gt;Hello&lt;/p&gt;</span></div></pre></div><p>React 通过以下方式来判断组件的类型：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// React 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">isReactComponent</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 检查方式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Greeting</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token class-name">Greeting</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">isReactComponent</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// {}</span></div></pre></div><h3 id="react-fiber"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#react-fiber"><span class="icon icon-link"></span></a>React Fiber</h3><blockquote><p>本节参考：<a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/watch?v=ZCuYPiUIONs&amp;list=PLb0IAmt7-GS3fZ46IGFirdqKTIxlws7e0&amp;index=5">A cartoon intro to fiber<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><p>本节主要概念（了解即可）：</p><ul><li>React 现在的渲染都是由 Fiber 来调度</li><li>Fiber 调度过程中的两个阶段（以 Render 为界）</li></ul><p><strong>Fiber</strong>（可译为丝）比线程还细的控制粒度，是 React16 中的新特性，旨在对渲染过程做更精细的调整。</p><p>产生原因：</p><ol><li>Fiber 之前的 <code>reconciler</code>（被称为 Stack reconciler）自顶向下的递归 <code>mount/update</code>，无法中断（持续占用主线程），这样主线程上的布局、动画等周期性任务以及交互响应就无法立即得到处理，影响体验</li><li>渲染过程中没有优先级可言</li></ol><p>React Fiber 的方式：</p><p>把一个耗时长的任务分成很多小片，每一个小片的运行时间很短，虽然总时间依然很长，但是在每个小片执行完之后，都给其他任务一个执行的机会，这样唯一的线程就不会被独占，其他任务依然有运行的机会。</p><p>React Fiber 把更新过程碎片化，执行过程如下面的图所示，每执行完一段更新过程，就把控制权交还给 React 负责任务协调的模块，看看有没有其他紧急任务要做，如果没有就继续去更新，如果有紧急任务，那就去做紧急任务。 维护每一个分片的数据结构，就是 Fiber。</p><p>有了分片之后，更新过程的调用栈如下图所示，中间每一个波谷代表深入某个分片的执行过程，每个波峰就是一个分片执行结束交还控制权的时机。让线程处理别的事情</p></div><img alt="Fiber示意图" src="/black-react-guidebook/static/fiber-example.e199a78d.png" width="540"/><div class="markdown"><p>Fiber 的调度过程分为以下两个阶段：</p><p><code>render/reconciliation</code> 阶段 — 里面的所有生命周期函数都可能被执行多次，所以尽量保证状态不变</p><ul><li><code>componentWillMount</code></li><li><code>componentWillReceiveProps</code></li><li><code>shouldComponentUpdate</code></li><li><code>componentWillUpdate</code></li></ul><p><code>Commit</code> 阶段 — 不能被打断，只会执行一次</p><ul><li><code>componentDidMount</code></li><li><code>componentDidUpdate</code></li><li><code>compoenntWillunmount</code></li></ul><p>Fiber 的增量更新需要更多的上下文信息，之前的 VirtualDOM Tree 显然难以满足，所以扩展出了 Fiber Tree（即 Fiber 上下文的 VirtualDOM Tree），更新过程就是根据输入数据以及现有的 Fiber Tree 构造出新的 Fiber Tree（<code>workInProgress tree</code>）。</p><p>与 Fiber 有关的所有代码位于 <a target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/react/tree/v16.8.6/packages/react-reconciler">packages/react-reconciler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中，一个 Fiber 节点的详细定义如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">FiberNode</span><span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token parameter operator">:</span><span class="token parameter"> WorkTag</span><span class="token parameter punctuation">,</span><span class="token parameter"> pendingProps</span><span class="token parameter operator">:</span><span class="token parameter"> mixed</span><span class="token parameter punctuation">,</span><span class="token parameter"> key</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token parameter"> mode</span><span class="token parameter operator">:</span><span class="token parameter"> TypeOfMode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Instance</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> tag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> key</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Fiber</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">index</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ref</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 重点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">contextDependencies</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> mode</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Effects</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/** 细节略 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>我们只关注一下 <code>this.memoizedState</code>。</p><p>这个 <code>key</code> 用来存储在上次渲染过程中最终获得的节点的 <code>state</code>，每次 <code>render</code> 之前，React 会计算出当前组件最新的 <code>state</code> 然后赋值给组件，再执行 <code>render</code>。类组件和使用 <code>useState</code> 的函数组件均适用。</p><p>记住上面这句话，后面还会经常提到 <code>memoizedState</code>。</p><blockquote><p>有关 Fiber 每个 key 的具体含义可以参见 <a target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiber.js#L84-L218">源码的注释<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><h3 id="react-渲染器与-setstate"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#react-渲染器与-setstate"><span class="icon icon-link"></span></a>React 渲染器与 setState</h3><blockquote><p>本节参考： <a target="_blank" rel="noopener noreferrer" href="https://overreacted.io/how-does-setstate-know-what-to-do/">How Does setState Know What to Do?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><p>本节主要概念：</p><ul><li>React 渲染器是什么</li><li>setState 为什么能够触发更新</li></ul><p>由于 React 体系的复杂性以及目标平台的多样性。<code>react</code> 包只暴露一些定义组件的 API。绝大多数 React 的实现都存在于 渲染器（renderers）中。</p><p><code>react-dom</code>、<code>react-dom/server</code>、 <code>react-native</code>、 <code>react-test-renderer</code>、 <code>react-art</code> 都是常见的渲染器</p><p>这就是为什么不管目标平台是什么，<code>react</code> 包都是可用的。从 <code>react</code> 包中导出的一切，比如 <code>React.Component</code>、<code>React.createElement</code>、 <code>React.Children</code> 和 <code>Hooks</code> 都是独立于目标平台的。无论运行 <code>React DOM</code>，还是 <code>React DOM Server</code>,或是 <code>React Native</code>，组件都可以使用同样的方式导入和使用。</p><p>所以当我们想使用新特性时，<code>react</code> 和 <code>react-dom</code> 都需要被更新。</p><blockquote><p>例如，当 React 16.3 添加了 Context API，<code>React.createContext()</code> API 会被 React 包暴露出来。</p><p>但是 <code>React.createContext()</code> 其实并没有实现 <code>context</code>。因为在 <code>React DOM</code> 和 <code>React DOM Server</code> 中同样一个 API 应当有不同的实现。所以 <code>createContext()</code> 只返回了一些普通对象： **所以，如果你将 <code>react</code> 升级到了 16.3+，但是不更新 <code>react-dom</code>，那么你就使用了一个尚不知道 <code>Provider</code> 和 <code>Consumer</code> 类型的渲染器。**这就是为什么老版本的 <code>react-dom</code> 会报错说这些类型是无效的。</p></blockquote><p>这就是 <code>setState</code> 尽管定义在 React 包中，调用时却能够更新 DOM 的原因。它读取由 <code>React DOM</code> 设置的 <code>this.updater</code>，让 <code>React DOM</code> 安排并处理更新。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token maybe-class-name">Component</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// setState 所做的一切就是委托渲染器创建这个组件的实例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token punctuation">.</span><span class="token method function property-access">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> partialState</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;setState&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>各个渲染器中的 <code>updater</code> 触发不同平台的更新渲染</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// React DOM 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> inst </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOMUpdater</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// React DOM Server 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> inst </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOMServerUpdater</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// React Native 内部</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> inst </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">inst</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactNativeUpdater</span><span class="token punctuation">;</span></div></pre></div><p>至于 <code>updater</code> 的具体实现，就不是这里重点要讨论的内容了，下面让我们正式进入本文的主题：React Hooks。</p><h2 id="了解-usestate"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#了解-usestate"><span class="icon icon-link"></span></a>了解 useState</h2><h3 id="引入和触发更新"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#引入和触发更新"><span class="icon icon-link"></span></a>引入和触发更新</h3><p>本节主要概念：</p><ul><li><code>useState</code> 是如何被引入以及调用的</li><li><code>useState</code> 为什么能触发组件更新</li></ul><p>所有的 Hooks 在 React.js 中被引入，挂载在 React 对象中</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// React.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useCallback</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useContext</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useEffect</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useImperativeHandle</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useDebugValue</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useLayoutEffect</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useMemo</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useReducer</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useRef</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports">  useState</span><span class="token imports punctuation">,</span><span class="token imports"></span></div><div class="token-line"><span class="token imports"></span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./ReactHooks&#x27;</span><span class="token punctuation">;</span></div></pre></div><p>我们进入 ReactHooks.js 来看看，发现 <code>useState</code> 的实现竟然异常简单，只有短短两行</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// ReactHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> useState</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain">initialState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dispatcher </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> dispatcher</span><span class="token punctuation">.</span><span class="token method function property-access">useState</span><span class="token punctuation">(</span><span class="token plain">initialState</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>看来重点都在这个 <code>dispatcher</code> 上，<code>dispatcher</code> 通过 <code>resolveDispatcher()</code> 来获取，这个函数同样也很简单，只是将 <code>ReactCurrentDispatcher.current</code> 的值赋给了 <code>dispatcher</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// ReactHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dispatcher </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> dispatcher</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>所以 <code>useState(xxx)</code> 等价于 <code>ReactCurrentDispatcher.current.useState(xxx)</code>。</p><p>看到这里，我们回顾一下第一章第三小节所讲的 React 渲染器与 <code>setState</code>，是不是发现有点似曾相识。</p><p>与 <code>updater</code> 是 <code>setState</code> 能够触发更新的核心类似，<code>ReactCurrentDispatcher.current.useState</code> 是 <code>useState</code> 能够触发更新的关键原因，这个方法的实现并不在<code>react</code> 包内。下面我们就来分析一个具体更新的例子。</p><h3 id="示例分析"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#示例分析"><span class="icon icon-link"></span></a>示例分析</h3><p>以全文开头给出的代码为例。</p><p>我们从 Fiber 调度的开始：<code>ReactFiberBeginwork</code> 来谈起</p><p>之前已经说过，React 有能力区分不同的组件，所以它会给不同的组件类型打上不同的 <code>tag</code>， 详见 <a target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/react/blob/v16.8.6/packages/shared/ReactWorkTags.js">shared/ReactWorkTags.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>所以在 <code>beginWork</code> 的函数中，就可以根据 <code>workInProgess</code>（就是个 <code>Fiber</code> 节点）上的 <code>tag</code> 值来走不同的方法来加载或者更新组件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// ReactFiberBeginWork.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">current</span><span class="token parameter operator">:</span><span class="token parameter"> Fiber </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  renderExpirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> ExpirationTime</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/** 省略与本文无关的部分 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 根据不同的组件类型走不同的方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 不确定组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">IndeterminateComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> elementType </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 加载初始组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        elementType</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 函数组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 更新函数组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 类组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">ClassComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">/** 细节略 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  	</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>下面我们来找出 <code>useState</code> 发挥作用的地方。</p><h4 id="第一次加载"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#第一次加载"><span class="icon icon-link"></span></a>第一次加载</h4><p><code>mount</code> 过程执行 <code>mountIndeterminateComponent</code> 时，会执行到 <code>renderWithHooks</code> 这个函数</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">_current</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  workInProgress</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  Component</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  renderExpirationTime</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"> </span><span class="token comment">/** 省略准备阶段代码 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// value 就是渲染出来的 APP 组件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> value</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  value </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    context</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    renderExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/** 省略无关代码 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>执行前：<code>nextChildren = value</code></p></div><img alt="执行前1" src="/black-react-guidebook/static/fiber-first-mount-1.5fdcac0d.png" width="640"/><div class="markdown"><p>执行后：<code>value = 组件的虚拟 DOM 表示</code></p></div><img alt="执行后1" src="/black-react-guidebook/static/fiber-first-mount-2.5fdcac0d.png" width="640"/><div class="markdown"><p>至于这个 <code>value</code> 是如何被渲染成真实的 DOM 节点，我们并不关心，<code>state</code> 值我们已经通过 <code>renderWithHooks</code> 取到并渲染。</p><h4 id="更新重渲染"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#更新重渲染"><span class="icon icon-link"></span></a>更新重渲染</h4><p>点击一下按钮：此时 <code>count</code> 从 0 变为 3。</p><p>更新过程执行的是 <code>updateFunctionComponent</code> 函数，同样会执行到 <code>renderWithHooks</code> 这个函数，我们来看一下这个函数执行前后发生的变化：</p><p><strong>执行前：</strong><code>nextChildren = undefined</code></p></div><img alt="执行前2" src="/black-react-guidebook/static/fiber-update-1.2f28b4fd.png" width="640"/><div class="markdown"><p><strong>执行后：</strong> <code>nextChildren = 更新后的组件的虚拟 DOM 表示</code></p></div><img alt="执行后2" src="/black-react-guidebook/static/fiber-update-2.435c4218.png" width="640"/><div class="markdown"><p>同样的，至于这个 <code>nextChildren</code> 是如何被渲染成真实的 DOM 节点，我们并不关心，最新的 <code>state</code> 值我们已经通过 <code>renderWithHooks</code> 取到并渲染。</p><p>所以，<code>renderWithHooks</code> 函数就是处理各种 <code>hooks</code> 逻辑的核心部分。</p><h2 id="核心步骤分析"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#核心步骤分析"><span class="icon icon-link"></span></a>核心步骤分析</h2><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/facebook/react/blob/v16.8.6/packages/react-reconciler/src/ReactFiberHooks.js">ReactFiberHooks.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 包含着各种关于 Hooks 逻辑的处理，本章中的代码均来自该文件。</p><h3 id="hook-对象"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#hook-对象"><span class="icon icon-link"></span></a>Hook 对象</h3><p>在之前的章节有介绍过，Fiber 中的 <code>memorizedStated</code> 用来存储 <code>state</code>。</p><p>在类组件中 <code>state</code> 是一整个对象，可以和 <code>memoizedState</code> 一一对应。但是在 Hooks 中，React 并不知道我们调用了几次 <code>useState</code>，所以 React 通过将一个 Hook 对象挂载在 <code>memorizedStated</code> 上来保存函数组件的 <code>state</code>。</p><p>Hook 对象的结构如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// ReactFiberHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  memoizedState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  baseState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  baseUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">,</span><span class="token plain"> any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  queue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">,</span><span class="token plain"> any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>重点关注 <code>memoizedState</code> 和 <code>next</code>。</p><p><code>memoizedState</code> 是用来记录当前 <code>useState</code> 应该返回的结果的。</p><ul><li><code>queue</code>：缓存队列，存储多次更新行为</li><li><code>next</code>：指向下一次 <code>useState</code> 对应的 Hook 对象。</li></ul><p>结合示例代码来看：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">import</span><span class="token plain"> React</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> useState </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token string">&#x27;./App.css&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">count</span><span class="token punctuation">,</span><span class="token plain"> setCount</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">,</span><span class="token plain"> setName</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&#x27;Star&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 调用三次setCount便于查看更新队列的情况</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">countPlusThree</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token plain">count </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">className</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">App</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">{</span><span class="token plain">name</span><span class="token punctuation">}</span><span class="token plain"> Has Clicked </span><span class="token tag punctuation">&lt;</span><span class="token tag">strong</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">count</span><span class="token punctuation">}</span><span class="token tag punctuation">&lt;/</span><span class="token tag">strong</span><span class="token tag punctuation">&gt;</span><span class="token plain"> Times</span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag">button</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">countPlusThree</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain">Click </span><span class="token operator">*</span><span class="token number">3</span><span class="token tag punctuation">&lt;/</span><span class="token tag">button</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>第一次点击按钮触发更新时，<code>memoizedState</code> 的结构如下</p></div><img alt="第一次触发更新的memoizedState" src="/black-react-guidebook/static/memoized-state-1.f6461545.png" width="520"/><div class="markdown"><p>只是符合之前对 Hook 对象结构的分析，只是 <code>queue</code> 中的结构貌似有点奇怪，我们将在第三章第 2 节中进行分析。</p><h3 id="renderwithhooks"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#renderwithhooks"><span class="icon icon-link"></span></a>renderWithHooks</h3><p><code>renderWithHooks</code> 的运行过程如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// ReactFiberHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">current</span><span class="token parameter operator">:</span><span class="token parameter"> Fiber </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  Component</span><span class="token parameter operator">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  props</span><span class="token parameter operator">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  refOrContext</span><span class="token parameter operator">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  nextRenderExpirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> ExpirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> any </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderExpirationTime </span><span class="token operator">=</span><span class="token plain"> nextRenderExpirationTime</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  currentlyRenderingFiber </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 如果 current 的值为空，说明还没有 hook 对象被挂载</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 而根据 hook 对象结构可知，current.memoizedState 指向下一个 current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  nextCurrentHook </span><span class="token operator">=</span><span class="token plain"> current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 用 nextCurrentHook 的值来区分 mount 和 update，设置不同的 dispatcher</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextCurrentHook </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token comment">// 初始化时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">HooksDispatcherOnMount</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">:</span><span class="token plain"> </span><span class="token comment">// 更新时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">HooksDispatcherOnUpdate</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 此时已经有了新的 dispatcher,在调用 Component 时就可以拿到新的对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> children </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">Component</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">,</span><span class="token plain"> refOrContext</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 重置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ContextOnlyDispatcher</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> renderedWork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">currentlyRenderingFiber</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 更新 memoizedState 和 updateQueue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderedWork</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> firstWorkInProgressHook</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderedWork</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">componentUpdateQueue</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/** 省略与本文无关的部分代码，便于理解 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h4 id="初始化时"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#初始化时"><span class="icon icon-link"></span></a>初始化时</h4><p><strong>核心：</strong> 创建一个新的 hook，初始化 <code>state</code>， 并绑定触发器。</p><p>初始化阶段 <code>ReactCurrentDispatcher.current</code> 会指向 <code>HooksDispatcherOnMount</code> 对象</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// ReactFiberHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">HooksDispatcherOnMount</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatcher</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">/** 省略其它Hooks **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  useState</span><span class="token operator">:</span><span class="token plain"> mountState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 所以调用 useState(0) 返回的就是 HooksDispatcherOnMount.useState(0)，也就是 mountState(0)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> mountState</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  initialState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatch</span><span class="token operator">&lt;</span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 访问 Hook 链表的下一个节点，获取到新的 Hook 对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 如果入参是 function 则会调用，但是不提供参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> initialState </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    initialState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">initialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 进行 state 的初始化工作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">baseState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> initialState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 进行 queue 的初始化工作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> queue </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    last</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    dispatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    eagerReducer</span><span class="token operator">:</span><span class="token plain"> basicStateReducer</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// useState 使用基础 reducer</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    eagerState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">initialState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">	</span><span class="token comment">// 返回触发器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dispatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatch</span><span class="token operator">&lt;</span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">.</span><span class="token property-access">dispatch</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">dispatchAction</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 绑定当前 fiber 节点和 queue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">currentlyRenderingFiber</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      queue</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 返回初始 state 和触发器</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">,</span><span class="token plain"> dispatch</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 对于 useState 触发的 update action 来说（假设 useState 里面都传的变量），basicStateReducer 就是直接返回 action 的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> basicStateReducer</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> action</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> action </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function">action</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> action</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>重点讲一下返回的这个更新函数 <code>dispatchAction</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> dispatchAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">,</span><span class="token plain"> queue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"> action</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">A</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/** 省略 Fiber 调度相关代码 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 创建新的新的 update, action 就是我们 setCount 里面的值 (count+1, count+2, count+3…)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> update</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    expirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    action</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    eagerReducer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    eagerState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 重点：构建 queue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// queue.last 是最近的一次更新，然后 last.next 开始是每一次的 action</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> last </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">last</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">last </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 只有一个 update, 自己指自己-形成环</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> first </span><span class="token operator">=</span><span class="token plain"> last</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">first </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> first</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    last</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  queue</span><span class="token punctuation">.</span><span class="token property-access">last</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/** 省略特殊情况相关代码 **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 创建一个更新任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">scheduleWork</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>在 <code>dispatchAction</code> 中维护了一份 <code>queue</code> 的数据结构。</p><p><code>queue</code> 是一个有环链表，规则：</p><ul><li><code>queue.last</code> 指向最近一次更新</li><li><code>last.next</code> 指向第一次更新</li><li>后面就依次类推，最终倒数第二次更新指向 <code>last</code>，形成一个环。</li></ul><p>所以每次插入新 <code>update</code> 时，就需要将原来的 <code>first</code> 指向 <code>queue.last.next</code>。再将 <code>update</code> 指向 <code>queue.next</code>，最后将 <code>queue.last</code> 指向 <code>update</code>。</p><p>下面结合示例代码来画图说明一下：</p><p>前面给出了第一次点击按钮更新时，<code>memorizedState</code> 中的 <code>queue</code> 值。</p></div><img alt="第一次触发更新的queue值" src="/black-react-guidebook/static/memorized-state-queue.2bd4552c.png" width="520"/><div class="markdown"><p>其构建过程如下图所示：</p></div><img alt="memorizedState构建过程" src="/black-react-guidebook/static/memorized-state-build.0ae0f6e7.png" width="520"/><div class="markdown"><p>即保证 <code>queue.last</code> 始终为最新的 <code>action</code>, 而 <code>queue.last.next</code> 始终为 <code>action: 1</code></p><h4 id="更新时"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#更新时"><span class="icon icon-link"></span></a>更新时</h4><p>**核心：**获取该 Hook 对象中的 <code>queue</code>，内部存有本次更新的一系列数据，进行更新</p><p>更新阶段 <code>ReactCurrentDispatcher.current</code> 会指向 <code>HooksDispatcherOnUpdate</code> 对象</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// ReactFiberHooks.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 所以调用 useState(0) 返回的就是 HooksDispatcherOnUpdate.useState(0)，也就是 updateReducer(basicStateReducer, 0)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">HooksDispatcherOnUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatcher</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/** 省略其它Hooks **/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">   useState</span><span class="token operator">:</span><span class="token plain"> updateState</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token plain">basicStateReducer</span><span class="token punctuation">,</span><span class="token plain"> initialState</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 可以看到 updateReducer 的过程与传的 initalState 已经无关了，所以初始值只在第一次被使用</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 为了方便阅读，删去了一些无关代码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 查看完整代码：https://github.com/facebook/react/blob/487f4bf2ee7c86176637544c5473328f96ca0ba2/packages/react-reconciler/src/ReactFiberHooks.js#L606</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token parameter punctuation">,</span><span class="token parameter"> initialArg</span><span class="token parameter punctuation">,</span><span class="token parameter"> init</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 获取初始化时的 hook</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> queue </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 开始渲染更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">numberOfReRenders </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> dispatch </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">dispatch</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">renderPhaseUpdates </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 获取 Hook 对象上的 queue，内部存有本次更新的一系列数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> firstRenderPhaseUpdate </span><span class="token operator">=</span><span class="token plain"> renderPhaseUpdates</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">firstRenderPhaseUpdate </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderPhaseUpdates</span><span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span><span class="token plain">queue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> newState </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> firstRenderPhaseUpdate</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 获取更新后的 state</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> action </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">.</span><span class="token property-access">action</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 此时的 reducer 是 basicStateReducer，直接返回 action 的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          newState </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">reducer</span><span class="token punctuation">(</span><span class="token plain">newState</span><span class="token punctuation">,</span><span class="token plain"> action</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          update </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">update </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 对 更新 hook.memoized</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newState</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 返回新的 state，及更新 hook 的 dispatch 方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">newState</span><span class="token punctuation">,</span><span class="token plain"> dispatch</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 对于 useState 触发的 update action 来说（假设 useState 里面都传的变量），basicStateReducer 就是直接返回 action 的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> basicStateReducer</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> action</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">typeof</span><span class="token plain"> action </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function">action</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> action</span><span class="token punctuation">;</span></div></pre></div><h4 id="总结"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#总结"><span class="icon icon-link"></span></a>总结</h4><p>单个 Hooks 的更新行为全都挂在 <code>Hooks.queue</code> 下，所以能够管理好 <code>queue</code> 的核心就在于</p><ul><li>初始化 queue - <code>mountState</code></li><li>维护 queue - <code>dispatchAction</code></li><li>更新 queue - <code>updateReducer</code></li></ul><p>结合示例代码：</p><ul><li>当我们第一次调用 <code>[count, setCount] = useState(0)</code> 时，创建一个 <code>queue</code></li><li>每一次调用 <code>setCount(x)</code>，就 <code>dispach</code> 一个内容为 <code>x</code> 的 <code>action</code>（<code>action</code> 的表现为：将 <code>count</code> 设为 <code>x</code>），<code>action</code> 存储在 <code>queue</code> 中，以前面讲述的有环链表规则来维护</li><li>这些 <code>action</code> 最终在 <code>updateReducer</code> 中被调用，更新到 <code>memorizedState</code> 上，使我们能够获取到最新的 <code>state</code> 值</li></ul><h2 id="总结-1"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#总结-1"><span class="icon icon-link"></span></a>总结</h2><h3 id="使用原则"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#使用原则"><span class="icon icon-link"></span></a>使用原则</h3><p>官方文档对于使用 hooks 有以下两点要求：</p><ul><li>只在 React 函数中使用 Hooks</li><li>只在自定义 Hooks 中使用 Hooks</li></ul><h3 id="为什么不能在循环条件语句中执行"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#为什么不能在循环条件语句中执行"><span class="icon icon-link"></span></a>为什么不能在循环/条件语句中执行</h3><p>以 <code>useState</code> 为例：</p><p>和类组件存储 state 不同，React 并不知道我们调用了几次 <code>useState</code>，对 <code>hooks</code> 的存储是按顺序的（参见 Hook 结构），一个 <code>hook</code> 对象的 <code>next</code> 指向下一个 <code>hooks</code>。所以当我们建立示例代码中的对应关系后，<code>Hook</code> 的结构如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// hook1: const [count, setCount] = useState(0) — 拿到state1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  memorizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// hook2: const [name, setName] = useState(&#x27;Star&#x27;) - 拿到state2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    memorizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;Star&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// hook1 =&gt; Fiber.memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// state1 === hook1.memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// hook1.next =&gt; hook2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// state2 === hook2.memoizedState</span></div></pre></div><p>所以如果把 <code>hook1</code> 放到一个 <code>if</code> 语句中，当这个没有执行时，<code>hook2</code> 拿到的 <code>state</code> 其实是上一次 <code>hook1</code> 执行后的 <code>state</code>（而不是上一次 <code>hook2</code> 执行后的）。这样显然会发生错误。</p><blockquote><p>关于这块内容如果想了解更多可以看一下 <a target="_blank" rel="noopener noreferrer" href="https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba">这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote><h3 id="为什么只能在函数组件中使用-hooks"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#为什么只能在函数组件中使用-hooks"><span class="icon icon-link"></span></a>为什么只能在函数组件中使用 hooks</h3><p>只有函数组件的更新才会触发 <code>renderWithHooks</code> 函数，处理 Hooks 相关逻辑。</p><p>还是以 <code>setState</code> 为例，类组件和函数组件重新渲染的逻辑不同 ：</p><ul><li><strong>类组件：</strong> 用 <code>setState</code> 触发 <code>updater</code>，重新执行组件中的 <code>render</code> 方法</li><li><strong>函数组件：</strong> 用 <code>useState</code> 返回的 <code>setter</code> 函数来 <code>dispatch</code> 一个 <code>update action</code>，触发更新（<code>dispatchAction</code> 最后的 <code>scheduleWork</code>），用 <code>updateReducer</code> 处理更新逻辑，返回最新的 <code>state</code> 值（与 Redux 比较像）</li></ul><h3 id="usestate-整体运作流程总结"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#usestate-整体运作流程总结"><span class="icon icon-link"></span></a>useState 整体运作流程总结</h3><p>说了这么多，最后再简要总结下 <code>useState</code> 的执行流程。</p><ul><li><strong>初始化：</strong> 构建 <code>dispatcher</code> 函数和初始值。</li><li><strong>更新时：</strong><ol><li>调用 <code>dispatcher</code> 函数，按序插入 <code>update</code>（其实就是一个 <code>action</code>）</li><li>收集 <code>update</code>，调度一次 React 的更新</li><li>在更新的过程中将 <code>ReactCurrentDispatcher.current</code> 指向负责更新的 <code>Dispatcher</code></li><li>执行到函数组件 <code>App()</code> 时，<code>useState</code> 会被重新执行，在 <code>resolve dispatcher</code> 的阶段拿到了负责更新的 <code>dispatcher</code>。</li><li><code>useState</code> 会拿到 Hook 对象，<code>Hook.queue</code> 中存储了更新队列，依次进行更新后，即可拿到最新的 <code>state</code></li><li>函数组件 <code>App()</code> 执行后返回的 <code>nextChild</code> 中的 <code>count</code> 值已经是最新的了。<code>FiberNode</code> 中的 <code>memorizedState</code> 也被设置为最新的 <code>state</code></li><li>Fiber 渲染出真实 DOM，更新结束。</li></ol></li></ul><h2 id="参考资料"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/hooks/hooks-analysis#参考资料"><span class="icon icon-link"></span></a>参考资料</h2><ul><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/6844903833764642830">📝 从源码剖析 useState 的执行过程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/6844903990958784526">📝 React Hooks 源码解析：useState<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook/edit/master/docs/infrastructure/hooks/hooks-analysis.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2023/7/9 17:25:56</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/black-react-guidebook/umi.f5521da1.js"></script>
  </body>
</html>
