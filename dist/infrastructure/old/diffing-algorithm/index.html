<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/black-react-guidebook/umi.b283d7b5.css" />
    <script>
      window.routerBase = "/black-react-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.20
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>DOM DIFF 算法</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/infrastructure/old/diffing-algorithm" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/black-react-guidebook//">React Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/black-react-guidebook//foundation">基础</a></span><span><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure">架构</a></span><span><a href="/black-react-guidebook//ecosystem">生态</a></span><span><a href="/black-react-guidebook//api-reference">API</a></span><span><a href="/black-react-guidebook//extensions">扩展</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/black-react-guidebook//"></a><h1>React Guidebook</h1><p>React 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/black-react-guidebook//foundation">基础</a></li><li><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure">架构</a></li><li><a href="/black-react-guidebook//ecosystem">生态</a></li><li><a href="/black-react-guidebook//api-reference">API</a></li><li><a href="/black-react-guidebook//extensions">扩展</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">新版架构</a><ul><li><a href="/black-react-guidebook//infrastructure/new/fiber"><span>Fiber</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/reconciliation"><span>Reconciliation</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/concurrent"><span>Concurrent</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/scheduler"><span>Scheduler</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">Hooks</a><ul><li><a href="/black-react-guidebook//infrastructure/hooks"><span>Hooks</span></a></li><li><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis"><span>源码分析</span></a></li><li><a href="/black-react-guidebook//infrastructure/hooks/use-state"><span>useState</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">旧版架构</a><ul><li><a href="/black-react-guidebook//infrastructure/old/virtual-dom"><span>Virtual DOM</span></a></li><li><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure/old/diffing-algorithm"><span>DOM DIFF 算法</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="传统算法" data-depth="2"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#传统算法"><span>传统算法</span></a></li><li title="算法实现" data-depth="2"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#算法实现"><span>算法实现</span></a></li><li title="算法策略" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#算法策略"><span>算法策略</span></a></li><li title="算法粒度" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#算法粒度"><span>算法粒度</span></a></li><li title="算法源码" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#算法源码"><span>算法源码</span></a></li><li title="更新渲染" data-depth="2"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#更新渲染"><span>更新渲染</span></a></li><li title="合并操作" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#合并操作"><span>合并操作</span></a></li><li title="子树渲染" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#子树渲染"><span>子树渲染</span></a></li><li title="选择性子树渲染" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#选择性子树渲染"><span>选择性子树渲染</span></a></li><li title="总结" data-depth="2"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#总结"><span>总结</span></a></li><li title="结论" data-depth="2"><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm#结论"><span>结论</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="dom-diff-算法"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#dom-diff-算法"><span class="icon icon-link"></span></a>DOM DIFF 算法</h1><p>diff 算法作为 Virtual DOM 的加速器，其算法的改进优化是 React 整个界面渲染的基础和性能的保障，同时也是 React 源码中最神秘的，最不可思议的部分</p><p>diff 算法会帮助我们就算出 VirtualDOM 中真正变化的部分，并只针对该部分进行原生 DOM 操作，而不是渲染整个页面。从而保证了每次操作更新后页面的高效渲染。</p><h2 id="传统算法"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#传统算法"><span class="icon icon-link"></span></a>传统算法</h2><p>计算一棵树形结构转换为另一棵树形结构需要最少步骤，如果使用传统的 diff 算法通过循环递归遍历节点进行对比，其复杂度要达到 <strong>O(n^3)</strong>，其中 n 是树中节点总数，效率十分低下，假设我们要展示 1000 个节点，那么我们就要依次执行上十亿次的比较。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Traditional Diff Algorithm</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> res </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 比较子节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">diffLeafs</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">beforeLeaf</span><span class="token parameter punctuation">,</span><span class="token parameter"> afterLeaf</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 获取较大节点树的长度</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">max</span><span class="token punctuation">(</span><span class="token plain">beforeLeaf</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">,</span><span class="token plain"> after</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 循环遍历</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> count</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> beforeTag </span><span class="token operator">=</span><span class="token plain"> beforeLeaf</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> afterTag </span><span class="token operator">=</span><span class="token plain"> afterLeaf</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">beforeTag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 添加 afterTag 节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      res</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;add&#x27;</span><span class="token punctuation">,</span><span class="token plain"> element</span><span class="token operator">:</span><span class="token plain"> afterTag </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">afterTag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 删除 beforeTag节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      res</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;remove&#x27;</span><span class="token punctuation">,</span><span class="token plain"> element</span><span class="token operator">:</span><span class="token plain"> beforeTag </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">beforeTag</span><span class="token punctuation">.</span><span class="token property-access">tagName</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> afterTag</span><span class="token punctuation">.</span><span class="token property-access">tagName</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 节点名改变时,删除 beforeTag 节点,添加 afterTag 节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      res</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;remove&#x27;</span><span class="token punctuation">,</span><span class="token plain"> element</span><span class="token operator">:</span><span class="token plain"> beforeTag </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      res</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;add&#x27;</span><span class="token punctuation">,</span><span class="token plain"> element</span><span class="token operator">:</span><span class="token plain"> afterTag </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">beforeTag</span><span class="token punctuation">.</span><span class="token property-access">innerHTML</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> afterTag</span><span class="token punctuation">.</span><span class="token property-access">innerHTML</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">beforeTag</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        res</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;changed&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          beforeElement</span><span class="token operator">:</span><span class="token plain"> beforeTag</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          afterElement</span><span class="token operator">:</span><span class="token plain"> afterTag</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token constant">HTML</span><span class="token operator">:</span><span class="token plain"> afterTag</span><span class="token punctuation">.</span><span class="token property-access">innerHTML</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 递归比较</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">diffLeafs</span><span class="token punctuation">(</span><span class="token plain">beforeTag</span><span class="token punctuation">,</span><span class="token plain"> afterTag</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> res</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><h2 id="算法实现"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#算法实现"><span class="icon icon-link"></span></a>算法实现</h2><p>React 将 Virtual DOM 树转换为 Actual DOM 的最少操作过程称为<strong>调和</strong>（Reconciliation），diff 算法便是调和的具体实现。</p><p>React 通过制定大胆的策略，将 <strong>O(n^3)</strong> 复杂度的问题转换成 <strong>O(n)</strong> 复杂度的问题。</p><p>首先需要明确，只有 React 更新阶段才会有 diff 算法的运用。</p><h3 id="算法策略"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#算法策略"><span class="icon icon-link"></span></a>算法策略</h3><ul><li>Web UI 中 DOM 节点跨层级的移动操作特别少，可以忽略不计</li><li>拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构。</li><li>对于同一层级的一组子节点，它们可以通过 UUID（key）进行区分。</li></ul><p>基于以上三个前提策略，React 分别对 <strong>Tree Diff</strong>、<strong>Component Diff</strong>、<strong>Element Diff</strong> 进行算法优化，事实也证明这三个前提策略是合理且准确的，它保证了整体界面构建的性能。</p><h3 id="算法粒度"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#算法粒度"><span class="icon icon-link"></span></a>算法粒度</h3><h4 id="tree-diff"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#tree-diff"><span class="icon icon-link"></span></a>Tree Diff</h4><p>Tree Diff 即对树进行逐层对比的过程，两棵树只会对<strong>同层次的节点</strong>进行比较。</p><p>既然 WebUI 中的 DOM 节点跨层级的移动操作少到可以忽略不计，针对这一现象，React 通过 updateDepth 对 Virtual DOM 树进行层级控制，只会对相同颜色方框内的 DOM 节点进行比较，即同一个父节点下的所有子节点。当发现节点已经不存在，则该节点及其子节点会被完全删除掉，不会用于进一步的比较。这样只需要对树进行一次遍历，便能完成整个 DOM 树的比较。</p></div><img alt="TreeDiff" src="/black-react-guidebook/static/tree_diff_1.2079672f.jpg" width="640"/><div class="markdown"><p><strong>Question：当 DOM 节点进行跨层级操作时，diff 会有怎样的表现呢？</strong></p><p><strong>原理剖析：</strong></p><p>如下图所示，A 节点（包括其子节点）被整个移动到 D 节点下面去，由于 React 只会简单的考虑<strong>同级节点</strong>的位置变换，而对于不同层级的节点，只有创建和删除操作，所以当根节点发现 A 节点消失了，就会删除 A 节点及其子节点，当 D 发现多了一个子节点 A，就会创建新的 A 作为其子节点。</p><p>此时，diff 算法的执行情况是：<strong>create A =&gt; create B =&gt; create C =&gt; delete A</strong></p></div><img alt="TreeDiff 移动层级示例" src="/black-react-guidebook/static/tree_diff_2.cb083a95.jpg" width="640"/><div class="markdown"><p>由此可见，当出现节点跨层级的移动时，并不会出现想象中移动操作，而是会进行删除，重新创建的动作，这是一种很影响 React 性能的操作。因此 <strong>React 官方也不建议进行 DOM 节点跨层级的操作。</strong></p><blockquote><p>提示：在开发组件时，保持稳定的 DOM 结构会有助于性能的提升。例如，可以通过 CSS 隐藏或显示节点，而不是真的移除或添加 DOM 节点。</p></blockquote><h4 id="component-diff"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#component-diff"><span class="icon icon-link"></span></a>Component Diff</h4><p>在进行 Tree Diff 过程中，每层组件级别的对比，叫做 Component Diff。</p><ul><li>如果对比前后，组件的类型相同，则按照原策略继续进行 Virtual DOM 比较</li><li>如果对比前后，组件的类型不相同，则需要移除旧组件，创建新组件，并追加到页面上</li></ul><p>如果是同类型的组件，有可能经过一轮 Virtual DOM 比较下来，并没有发生变化。如果我们能够提前确切知道这一点，那么就可以省下大量的 diff 运算时间。因此，React 允许用户通过 <code>shouldComponentUpdate</code> 来判断该组件是否需要进行 diff 算法分析</p><p>如下图所示， 当 component D 变为 component G 时，即使这两个 component 结构相似，一旦 React 判断 D 和 G 是不同类型的组件，就不会比较两者的结构，而是直接删除组件 component D，重新创建 component G 及其子节点。虽然当两个组件是不同类型但结构相似时，进行 diff 算法分析会影响性能，但是毕竟不同类型的组件存在相似 DOM 树的情况在实际开发过程中很少出现，因此这种极端因素很难在实际开发过程中造成重大影响。</p></div><img alt="Component Diff 示例" src="/black-react-guidebook/static/component_diff.c9c48a88.jpg" width="640"/><div class="markdown"><h4 id="element-diff"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#element-diff"><span class="icon icon-link"></span></a>Element Diff</h4><p>在进行组件对比的时候，如果两个组件类型相同，则需要进行元素级别的对比，这叫做 Element Diff。</p><p>Element Diff 对应三种节点操作，分别为 <strong><code>INSERT_MARKUP</code>（插入）</strong>、<strong><code>MOVE_EXISTING</code>（移动）</strong> 和 <strong><code>REMOVE_NODE</code>（删除）</strong>。</p><ul><li><strong><code>INSERT_MARKUP</code></strong>：新的组件类型不在旧集合中，即全新的节点，需要对新节点进行插入操作。</li><li><strong><code>MOVE_EXISTING</code></strong>：旧集合中有新组件类型，且 <code>element</code> 是可更新的类型，generateComponent 已调用 recevieComponent，这种情况下 <code>prevChild = nextChild</code>，这时候就需要做移动操作，可以复用以前的 DOM 节点。</li><li><strong><code>REMOVE_NODE</code></strong>：旧组件类型，在新集合里也有，但对应的 <code>element</code> 不同则不能直接复用和更新，需要执行删除操作，或者旧组件不在新集合里的，也需要执行删除操作。</li></ul><p>如下图，老集合中包含节点：A、B、C、D，更新后的新集合中包含节点：B、A、D、C，此时新老集合进行 diff 差异化对比，发现 B != A，则创建并插入 B 至新集合，删除老集合 A；以此类推，创建并插入 A、D 和 C，删除 B、C 和 D。</p></div><img alt="ElementDiff_1" src="/black-react-guidebook/static/element_diff_1.24ba83a3.jpg" width="640"/><div class="markdown"><p>React 发现这类操作繁琐冗余，因为这些都是相同的节点，但由于位置发生变化，导致需要进行繁杂低效的删除、创建操作，其实只要对这些节点进行位置移动即可。</p><p>针对这种情况，React 提出优化策略：<strong>允许开发者对同一层级的同组子节点，添加唯一 key 进行区分</strong>，虽然只是小小的改动，性能上却发生了翻天覆地的变化。</p><p>新老集合所包含的节点，如下图所示，新老集合进行 diff 差异化对比，通过 key 发现新老集合中的节点都是相同的节点，因此无需进行节点删除和创建，只需要将老集合中节点的位置进行移动，更新为新集合中节点的位置，此时 React 给出的 diff 结果为：B、D 不做任何操作，A、C 进行移动操作，即可。</p></div><img alt="ElementDiff_2" src="/black-react-guidebook/static/element_diff_2.01e745a0.jpg" width="640"/><div class="markdown"><p>那么，如此高效的 diff 到底是如何运作的呢？让我们通过源码进行详细分析。</p><p>先搞清楚 3 个 index 索引：</p><ul><li>nextId：遍历 nextChildren 时候的 index，每遍历一个元素加 1</li><li>lastIndex：默认为 0，表示上次从 prevChildren 中取出元素时，这个元素在 prevChildren 中的 index</li><li>_mountIndex：元素在数组中的位置</li></ul><p><strong>element diff 逻辑概括</strong></p><p>首先对新集合的节点进行循环遍历，<code>for (name in nextChildren)</code>，通过唯一 key 可以判断新老集合中是否存在相同的节点，<code>if (prevChild === nextChild)</code>。</p><p>如果存在相同节点，则进行<strong>移动操作</strong>，但在移动前需要将当前节点在老集合中的位置与 lastIndex 进行比较，<code>if (child._mountIndex &lt; lastIndex)</code>，则进行节点移动操作，否则不执行该操作。</p><p>这是一种顺序优化手段，lastIndex 一直在更新，表示访问过的节点在老集合中最右的位置（即最大的位置），如果新集合中当前访问的节点比 lastIndex 大，说明当前访问节点在老集合中就比上一个节点位置靠后，则该节点不会影响其他节点的位置，因此不用添加到差异队列中，即不执行移动操作，只有当访问的节点比 lastIndex 小时，才需要进行移动操作。</p><p><strong>element diff 差异对比过程</strong></p><p>以上图为例，可以更为清晰直观的描述 diff 的差异对比过程：</p><ul><li>从新集合中取得 B，判断老集合中存在相同节点 B，通过对比节点位置判断是否进行移动操作<ul><li><strong>判断过程</strong>：B 在老集合中的位置 <code>B._mountIndex = 1</code>，此时 <code>lastIndex = 0</code>(首次遍历时默认为 0)，不满足<code>child._mountIndex &lt; lastIndex</code> 的条件，因此不对 B 进行移动操作</li><li><strong>更新索引</strong>：更新 <code>lastIndex = Math.max(prevChild._mountIndex, lastIndex)</code>，其中 <code>prevChild._mountIndex</code> 表示 B 在老集合中的位置，则 <code>lastIndex ＝ 1</code>，并将 B 的位置更新为新集合中的位置 <code>prevChild._mountIndex = nextIndex</code>，此时新集合中 <code>B._mountIndex = 0</code>，<code>nextIndex++</code> 进入下一个节点的判断。</li></ul></li><li>从新集合中取得 A，判断老集合中存在相同节点 A，通过对比节点位置判断是否进行移动操作<ul><li><strong>判断过程</strong>：A 在老集合中的位置 <code>A._mountIndex = 0</code>，此时 <code>lastIndex = 1</code>，满足 <code>child._mountIndex &lt; lastIndex</code> 的条件，因此对 A 进行移动操作 <code>enqueueMove(this, child._mountIndex, toIndex)</code>，其中 <code>toIndex</code> 其实就是 <code>nextIndex</code>，表示 A 需要移动到的位置</li><li><strong>更新索引</strong>：更新 <code>lastIndex = Math.max(prevChild._mountIndex, lastIndex)</code>，则 <code>lastIndex ＝ 1</code>，并将 A 的位置更新为新集合中的位置 <code>prevChild._mountIndex = nextIndex</code>，此时新集合中 <code>A._mountIndex = 1</code>，<code>nextIndex++</code> 进入下一个节点的判断。</li></ul></li><li>从新集合中取得 D，判断老集合中存在相同节点 D，通过对比节点位置判断是否进行移动操作<ul><li><strong>判断过程</strong>：D 在老集合中的位置 <code>D._mountIndex = 3</code>，此时 <code>lastIndex = 1</code>，不满足 <code>child._mountIndex &lt; lastIndex</code> 的条件，因此不对 D 进行移动操作</li><li><strong>更新索引</strong>：更新 <code>lastIndex = Math.max(prevChild._mountIndex, lastIndex)</code>，则 <code>lastIndex ＝ 3</code>，并将 D 的位置更新为新集合中的位置 <code>prevChild._mountIndex = nextIndex</code>，此时新集合中 <code>D._mountIndex = 2</code>，<code>nextIndex++</code> 进入下一个节点的判断。</li></ul></li><li>从新集合中取得 C，判断老集合中存在相同节点 C，通过对比节点位置判断是否进行移动操作<ul><li><strong>判断过程</strong>：C 在老集合中的位置 <code>C._mountIndex = 2</code>，此时 <code>lastIndex = 3</code>，满足 <code>child._mountIndex &lt; lastIndex</code> 的条件，因此对 C 进行移动操作 <code>enqueueMove(this, child._mountIndex, toIndex)</code></li><li><strong>更新索引</strong>：更新 <code>lastIndex = Math.max(prevChild._mountIndex, lastIndex)</code>，则 <code>lastIndex ＝ 3</code>，并将 C 的位置更新为新集合中的位置 <code>prevChild._mountIndex = nextIndex</code>，此时新集合中 <code>C._mountIndex = 3</code>，<code>nextIndex++</code> 进入下一个节点的判断，由于 C 已经是最后一个节点，因此 diff 到此完成。</li></ul></li></ul><p>以上主要分析新老集合中存在相同节点但位置不同时，对节点进行位置移动的情况，如果新集合中有新加入的节点且老集合存在需要删除的节点，那么 React diff 又是如何对比运作的呢？</p></div><img alt="ElementDiff_3" src="/black-react-guidebook/static/element_diff_3.c5fc0d95.jpg" width="640"/><div class="markdown"><p>以上图为例：</p><ul><li>从新集合中取得 B，判断老集合中存在相同节点 B<ul><li><strong>判断过程</strong>：由于 B 在老集合中的位置 <code>B._mountIndex = 1</code>，此时<code>lastIndex = 0</code>，因此不对 B 进行移动操作</li><li><strong>更新索引</strong>：更新 <code>lastIndex ＝ 1</code>，并将 B 的位置更新为新集合中的位置<code>B._mountIndex = 0</code>，<code>nextIndex++</code> 进入下一个节点的判断。</li></ul></li><li>从新集合中取得 E，判断老集合中不存在相同节点 E，则创建新节点 E<ul><li><strong>更新索引</strong>：更新 <code>lastIndex ＝ 1</code>，并将 E 的位置更新为新集合中的位置，<code>nextIndex++</code> 进入下一个节点的判断。</li></ul></li><li>从新集合中取得 C，判断老集合中存在相同节点 C<ul><li><strong>判断过程</strong>：由于 C 在老集合中的位置 <code>C._mountIndex = 2</code>，<code>lastIndex = 1</code>，此时 <code>C._mountIndex &gt; lastIndex</code>，因此不对 C 进行移动操作</li><li><strong>更新索引</strong>：更新 <code>lastIndex ＝ 2</code>，并将 C 的位置更新为新集合中的位置，<code>nextIndex++</code> 进入下一个节点的判断。</li></ul></li><li>从新集合中取得 A，判断老集合中存在相同节点 A<ul><li><strong>判断过程</strong>：由于 A 在老集合中的位置 <code>A._mountIndex = 0</code>，<code>lastIndex = 2</code>，此时 <code>A._mountIndex &lt; lastIndex</code>，因此对 A 进行移动操作</li><li><strong>更新索引</strong>：更新 <code>lastIndex ＝ 2</code>，并将 A 的位置更新为新集合中的位置，<code>nextIndex++</code> 进入下一个节点的判断。</li></ul></li><li>当完成新集合中所有节点 diff 时，最后还需要对老集合进行循环遍历，判断是否存在新集合中没有但老集合中仍存在的节点，发现存在这样的节点 D，因此删除节点 D，到此 diff 全部完成。</li></ul><p>当然，React diff 还是存在些许不足与待优化的地方，如下图所示，若新集合的节点更新为：D、A、B、C，与老集合对比只有 D 节点移动，而 A、B、C 仍然保持原有的顺序，理论上 diff 应该只需对 D 执行移动操作，然而由于 D 在老集合的位置是最大的，导致其他节点的 _mountIndex &lt; lastIndex，造成 D 没有执行移动操作，而是 A、B、C 全部移动到 D 节点后面的现象。</p></div><img alt="ElementDiff_4" src="/black-react-guidebook/static/element_diff_4.150a59ad.jpg" width="640"/><div class="markdown"><blockquote><p>建议：在开发过程中，尽量减少类似将最后一个节点移动到列表首部的操作，当节点数量过大或更新操作过于频繁时，在一定程度上会影响 React 的渲染性能。</p></blockquote><h3 id="算法源码"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#算法源码"><span class="icon icon-link"></span></a>算法源码</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function-variable function">_updateChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">nextNestedChildrenElements</span><span class="token parameter punctuation">,</span><span class="token parameter"> transaction</span><span class="token parameter punctuation">,</span><span class="token parameter"> context</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> prevChildren </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_renderedChildren</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> removedNodes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> mountImages </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 获取新的子元素数组</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> nextChildren </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_reconcilerUpdateChildren</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      prevChildren</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextNestedChildrenElements</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      mountImages</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      removedNodes</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      transaction</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      context</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">nextChildren </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">prevChildren</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> updates </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> name</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> nextIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> lastIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> nextMountIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> lastPlacedNode </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">name </span><span class="token keyword">in</span><span class="token plain"> nextChildren</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">nextChildren</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">(</span><span class="token plain">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">continue</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">var</span><span class="token plain"> prevChild </span><span class="token operator">=</span><span class="token plain"> prevChildren </span><span class="token operator">&amp;&amp;</span><span class="token plain"> prevChildren</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">var</span><span class="token plain"> nextChild </span><span class="token operator">=</span><span class="token plain"> nextChildren</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prevChild </span><span class="token operator">===</span><span class="token plain"> nextChild</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 同一个引用，说明是使用的同一个component,所以我们需要做移动的操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 移动已有的子节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// NOTICE：这里根据nextIndex, lastIndex决定是否移动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        updates </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          updates</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">moveChild</span><span class="token punctuation">(</span><span class="token plain">prevChild</span><span class="token punctuation">,</span><span class="token plain"> lastPlacedNode</span><span class="token punctuation">,</span><span class="token plain"> nextIndex</span><span class="token punctuation">,</span><span class="token plain"> lastIndex</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 更新lastIndex</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        lastIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">max</span><span class="token punctuation">(</span><span class="token plain">prevChild</span><span class="token punctuation">.</span><span class="token property-access">_mountIndex</span><span class="token punctuation">,</span><span class="token plain"> lastIndex</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 更新component的.mountIndex属性</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        prevChild</span><span class="token punctuation">.</span><span class="token property-access">_mountIndex</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> nextIndex</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prevChild</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 更新lastIndex</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          lastIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">max</span><span class="token punctuation">(</span><span class="token plain">prevChild</span><span class="token punctuation">.</span><span class="token property-access">_mountIndex</span><span class="token punctuation">,</span><span class="token plain"> lastIndex</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 添加新的子节点在指定的位置上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        updates </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          updates</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_mountChildAtIndex</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            nextChild</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            mountImages</span><span class="token punctuation">[</span><span class="token plain">nextMountIndex</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            lastPlacedNode</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            nextIndex</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            transaction</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            context</span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        nextMountIndex</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 更新nextIndex</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextIndex</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      lastPlacedNode </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactReconciler</span><span class="token punctuation">.</span><span class="token method function property-access">getHostNode</span><span class="token punctuation">(</span><span class="token plain">nextChild</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 移除掉不存在的旧子节点，和旧子节点和新子节点不同的旧子节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">name </span><span class="token keyword">in</span><span class="token plain"> removedNodes</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">removedNodes</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">(</span><span class="token plain">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        updates </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          updates</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_unmountChild</span><span class="token punctuation">(</span><span class="token plain">prevChildren</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"> removedNodes</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span></div></pre></div><h2 id="更新渲染"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#更新渲染"><span class="icon icon-link"></span></a>更新渲染</h2><h3 id="合并操作"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#合并操作"><span class="icon icon-link"></span></a>合并操作</h3><p>当调用 component 的 setState 方法的时候，React 将其标记为 dirty，到每一个事件循环结束，React 检查所有标记 dirty 的 component 重新绘制。</p><p>这里的<strong>合并操作</strong>是指，在一个事件循环当中，DOM 只会被更新一次，这个特性是构建高性能应用的关键，而且用通常的 JavaScript 代码难以实现，而在 React 应用里，你默认就能实现。</p></div><img alt="合并操作" src="data:image/png;base64,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" width="640"/><div class="markdown"><h3 id="子树渲染"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#子树渲染"><span class="icon icon-link"></span></a>子树渲染</h3><p>调用 <code>setState</code> 方法时，component 会重新构建包括子节点的 Virtual DOM。如果你在根节点调用 <code>setState</code>，整个 React 的应用都会被重新渲染。所有的 component 即便没有更新，都会调用他们的 <code>render</code> 方法。这个听起来可怕，性能貌似很低，但实际上我们不会触碰真实的 DOM，运行起来没那样的问题。</p><p>首先，我们讨论的是展示用户界面。因为屏幕空间有限，通常你需要一次渲染成百上千条指令，JavaScript 对于能处理的整个界面，在业务路基上已经足够快了。</p><p>令一点，在写 React 代码时，每当有数据更新，你不是都调用根节点的 <code>setState</code>。你会在需要接收对应更新的 component 上调用，或者在上面的几个 component。你很少要一直在根节点上，就是说界面更新只出现在用户产生交互的局部。</p></div><img alt="子树渲染" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYwAAADSCAIAAADWqGAuAAAb00lEQVR42uydR6sUSxiG+w+4deVK0YWgoCAIbsSNCxEXoogoiKKgqCgYwRzx6DEnFBSzImIWMecM5oDHnHO65tT3wc9Ttt3HmrmnB6bH+z4LGbpnqupMVb1fqh6DUAghMoxESgghkRJCCImUEEIiJYQQEikhhJBICSEkUkIIIZESQkikhBBCIiWEEBIpIYRESgghJFJCCImUEEJIpIQQQiL1G5cuXQqCoEmTJnv37v38+XMohJBIZYrFixcHldSoUWP06NGbNm26d+9eKISQSGWBq1evBlVRs2bNFStWPHnyJBTib+HNmzePHj0qbu8Sqerw/v17vrsjR46Ul5c3a9Ys+J2+fftev349TPDixYvz589//fo1FKJE6N69O0v6zJkzxe1dIpWW169fL126NPidPn36vH371r3ny5cvJmcDBw78/v17mB/v3r0LRQly8+bNtm3bzps37+HDh2HJ8uHDh4YNG5pMFKt3iVTBuHHjBt9m165dL168yOp0AeDly5ftDaTYybXb9VWrVoV5sH79et584MCBUJQagwcPDiphp3Xr1m3t2rUWuZQQ+P61a9fmTyDrWtzeJVIFoKKigm+TtWhe0tGjR+37hXPnzjmHa/78+VxftGhR1Atj7T579ixMwLLm43PmzAlFqdGhQ4egKtq3b8/aKKFVjaG1RVjc3iVSaXGCsnDhwmik1qpVK/Onktl0CwB79OgRVIKfdejQoTDChg0buD5y5EiE7/nz5xWVEEH07Nlz+vTppLei6fzZs2fv3r07FMWGebQ5PXjwIHHf6dOnyQbUr18/qKR3797Mfph5KATZgFlaxe1dIpUCr9dDUG15KOxqLF+O7vTq1StIgCR9+vSJD+JejRkzJqiKsWPH8i8tk793rbVo0cIEESc5FEXF4nRcZpsgx4ULF/CkAnBLohRWNWzZsqW4vUukCu9JOe7evct1wMk312nChAkuhwVdunQhL0hIWFZWFuSiXbt2KNTcuXN5PW7cONfL06dPkadf8abIwGJApP75QcxpGjVqVGpz4k8UFF4mTp48mWZg6XuXSBVsOqnchQko8di5BPwjYjozsBs3buRirVq1mNFoSYi7yeNX27ZtQ9TcWqcXDpGSoU9OJ0FfKLJRRcFXOnXqlM3y/v372bfXrl3jKQWm2KY1OvWUR5hWKu4Yodu3b9vFBw8eECQy1xRkSB106tTp7Nmz/kSBv8GYL4/hPH78OC/8LiHjx9bmbDzlwPy9S6QKwJo1a+wLNQ8/OW2cSOAWhR4zoVu3bk2Gh9++fevcuTPXMbYsIJOejh07xpbRxIkTuU6mwyW/rFI7YsSIUGSmisJWXL58efAH9uzZ46aPKY7dxQK5iY4yZcoUf6LA3yA2DIlk85ups1sLFixwsjV8+HDWUuPGjalOYlMt4UBrrMyco00xsNy9S6QKwM6dO02k3MkmMg7Ecc2bN+c6bN++nYtIlZ0qwL1KhodO16IGGRNKU1EDiF3l+vjx4+3Npmtonw67Z4R9+/aZzcA1DhKwBu7fv+/MUps2bVw2ffLkycyjm9whQ4YEEawY70kUHD582N8gq9RW3bp161ybZjURhZiCTJo0adiwYfb+fEabZmD+3nXivDBQcXN2acmSJVTfggiDBg0ya2CmZubMmSY0rVu39jjbuOK2hnD7wwjLli1zKSrS585ehSIb7Nixw+0utq4L4ZksUlTJApa5Xc7XcO7Dx48fd+3ahc+F+SFa5HEF3pNMFFhgiAA9fvzY3yDCEURwFhRNmTFjBi9MW8kBkfd0OsKVfEabZmD+3iVS/9mTx+VG/st+gNjj6eCgBn+gZcuWmBH38WnTpnFx5cqVJlL16tVz4WESUhjWCKoXO4YerWf/Si6KbMB2td3l5ouMpNOply9fugSz6VcSPJ3wD1SZKMizQacU0K9fP9TBsvgcdiF/FHNbGD9XXJnS33iagXHOOWfvEqm8sdKMF4JqjMPQoUPJdsc8IECwzHCxXGKhXBJLtJM3vXPnTvIwLiNBHBHBXxMpslRFsTMiSf8XB4Ew0AVfTGL//v2DCJhAj3/tSRT4G3QDM+uINLizeFOnTsXsRXP5VkF2sGL9jacZGCLu6V2PxVQn3YBwmAwRtWEHOLBHzYVlh4XEP8/zcTzmhtMft27dCr3Q4KtXr3LuB441hCIz8CyU7S4eQQ8jHDt2LKpTFFtcnI49O3HiBDbM/5s/LBtPoiBng7g5sSowQ7W8QYMGDWzArDdCLV6by28PpZLJ9jSecmD2jJ6/d4lUqYK7TlrhZ6VPZE+kkjG4S6Xz+xl40+YF84MkYX6w/z2JgpwNstut61gghmg2atSIW7FEKt2RCzNVJdnqGi/swCzc8/dO6CCRKuHNwNxT4g1FZmDnE7+wzexnMGKQvWbX4Sbwwj3Qx9HHmLt95coVfO3Vq1fHHnXyJApyNojjTyqKEmGsDkO2m1tBBFwYNMK9gZwDJ578jQ8YMIC7TZs2rcbAyF34e5dIlSqco9ETyKU+g9GjCVZ3Z58HEdA7t+2TiYL0DTqoIaImWL6kv4NG5Nl43bp1abx6A6tTpw5PDlXZu8K9kgQrbceRObYbipLF0i5VwuTi+JA2LkKDKRpP81n9fPBfeHyU2jaZqVCUMvgO1IL5lbFZs2bxxP/mzZv5zz6ow2SnwfSN+z+r3zj/O6F8+zMJKoSQSGUQe8IGcxQKISRS2XzUnuNz1GhDIYRESgghkRJCCImUEEIiJYQQEikhhJBICSEkUkIIIZESQvzfkUgJISRSQgghkRLiX/bOGKeRIIiiEyEyCMlMDghugIgJ4AakZFxhj8ANfAQi4g040B6h9skldWDwbHtmejzWvi/LMuOxhaH9qrp+d40SUioQV7Ll8mSXl5dd13FPF2CaE9JbNpRSQurgeLq7u+t2CFqJKqWE1GFEcy/aDyaMVqsV1+CDR3kccr29vXEwn31/fw+llJCaU/AoE6izszOu7bOLYjxVrlUdSikhNY+45NT5+Tnoub295XH0ar1eJ6dItUIpJaRmmOVRGk9CVbZzTk7BNetTakJzhjICI0pIqW29vLzUE6ro6emJV1GoCqU0Z4RU01JU1qF4MOCFJFOhlOaMkGonhsXghIjky0uoK80ZIdVWBK4EzeB5IvWpUEpzRkg1UrdRDFJGPO5DKc0ZIbVMSLkQQWnOCKm2ur+/z+ne4NdS7wylNGeEVLsQNyAbAmpfX19dh/zbKs0ZIdVSHx8fDIKLi4u98nCi4snJCS+EcaGU5oyQapqKn56eMg6ur6+jWldXV91GrjhXmjNCqqEIUOkKo/pYx2lkUm7fU5ozQmqOSgHCQ3l9fc0KJdiq5NrDw4Pb95TmjJBqWy9HQKccKTunfhxPDBSeynM4uTjEHAylNGeE1IRiuKQlTNV8q4he5nEsvXt+fv61UdmqvvUqau386HpOpTkjpCbegF5yqF07p9KO2RIHeYoTvr+bO/iU5oyQmnJ3Qk3uA3QAEKchIiE/9te2eFvePJTSnBFSY0QVKXcnxKTiDW0orDRnhNQEMW3A7oT6uGdHBKU5I6TGNsoYxhH3rCvNGSE1UymK6NR6LklXs1ApzRnNGSFVvyKuNMpoikIGmY3Pw4ioOSOkBpQGshQ1w6Sy24gxF0pzRnNGSFXaKxAKfMxWjLA4pTmjOSOkakdMT2nA4pTSnBFS/yOhSnHK7TKaM8Y/ITWOUO39HZsLa85ozgipJRKqdALK5NztMpozmjNCanGEKtHVXi6aM5ozQmrrn7cIQtnLxaCoOSOkerdKHVT2cpFQmjNCaomEspeLhNKcEVI/hxSKPpMXBVwurDRnhNQ0hGJa3oJQLhdWmjNCarIFvuQp09ocLhdWmjNCaoLm9oVQR5HrenUZS5+aM/8RpPK/0moLQvugRzQuySCFKmasWVnnsSvUJdRIc0ZIHQZJ5ZucM6abm5sjzW9JAPMjfH5+Zr3/uzjuegXNmcHmjJCau+q065uccQN+HW9ARitQS5bedbG5JxpmZ1lL7JozY8wZITW3h8KiNeZHZXxQeOap0n2V/tDHNeIfHx87tMFTfLv9YQ4rpzRnRpszQmouQvXO6SBXOefIYnJmT7tvazmlOTPOnBFSbUUcKF/RSpYxno6mm0ch1L845ZIFzZlG5oyQmubLjGFRv25l+b5G/p4MHwAcdTdKVC5Z0JxpZ84IqVFpFNEA6NRDbeHjic+SE4ff1YTK+tTKSZ/mzAhzpt+eYVwJqeHbkUij9s3MGU8LT6NAaex5W5tMac6MMGf67ZnklJAaONfbN3zleGKQLflDkYXH/reVnV40Z/Y2Z2rtmeSUkPrL3rnkRpEEYTjBki0ewt6MkJCYGYkFmhXcwLNjhbDEihXcwFwAyXsW+Ajs2HIEbuIjcISeTx3qmBnaDZGRGU1mEaHCKtPdrsrqjD8j48tHnUnazzHiduRuUVnbV5dIvciN/BLOVDaHdjyjcCZFqtqffZ1Efg5dKNdBwXJtz4Qz5vv04BnyCSlSv7pIyZSFq4ykEs6EwxknniFgTJGq82eqkWMMG56cOam0XxjO+PEMwVSKVKzc0CqKtI1cgc7rqw+eIexplZZwxlColqaQoqVIVTAXBnrUfoQQbPD+xUl97vw0E1IJZ2xWSiueITJIkbJ2rZU4VG1vzSMeP0I8r0+Z04DnDg6Z9zQUqhXPULQUKXuTpcTB6vzEutMwb3OeIDdqT5GqTOZiVxlJ7XVPsbOzM86v/T4YscZLvEG3t55o9ODld+sLde23XAUh4UzmpAbPaz5+/PjevXvCUz5//nxtCvPBgwdRS5HF69TfO0AxLx+Wgt25cycVKuFMJZzx4xl8KuledZuATkmLJ1JF0HSxNmari36NthSZHWYfHR3J/Z+s1eqCgxOKeXBQNvb8+fNVWsKZunyCH8/QjU2RqqgNutKY/Cpx07bdvn170ozyq1evuP/79++XLUOg379/L+eZL08444gQHXhG4EyKVEXKXFo5fWo6Kx2xxzjhV4m2CHHnHUxIlaIgBFZSLk7UZ3gpRx4knHEFUx48Q93LaTHWDTns2WLeI93AGedk/LBm8JI09RlMJZxx9GSNeCZXQQjfkINKNiP/olm2JERotzOYSjjj1SkTngHO5HpSFUjYlAWfP5giRPpmamsGUwln4uDMNp45OPjzv3AmV+a0JmgMfjtTMGWPjzKYSjiTcEasjL+vGdrvjmzpKk4aRmUwlXAm4YxYGTwVRb1pnCzK059leXwtbAZTCWcSzqiVYRWqfedFHHiA1XA8a31kMJVwJuGMWlmkQumf0vkKU6wG6UljSacjLeFMGJxJkfrWXe0KZe9G8XN8MEwT59nrUfwkLeFMGJxJkdrKlKtCdVI9RRUjVx13XcdPckWEhDOhcCanxXyLfvHYvg9FUcWwfqJVx/fccovQhDNhcCYnGP8/5Pb0y+bvE1FkrQfuvFtux5BwZsFwpuwzZPj48ePFxmS2gUyAUvQb+vWgVsPyYE6aRveIvqclnFkinCl7qBBIEoFM2TIUmv+XZxcaMPOINTPd0QbJ61P/cv2WhDMLhjMleklAyTRhBDPn9Gs2B9RX7PDw8NOnT9FCqQHL2IlMf94txyIknFkqnCnRYQL2Ysfm8/joqXPFbn/qZxIe7G/u0D4mwXIu/0O65PLyEkda/fKWcGZSOFNCReHYsK/zuUen/G7MCT5MwK9dTpJikiCLjua+rA29kPvRetNrROKjR4+0XNtGJftZUpVwJuHMWCKl0ntMqWoWATwJXpoHH75161bZYdQwrt5dmIhitoUDZbx7927HDhoXevv2bdlsxsefRY/k/wmsyKzrVH7uZ7V3SziTcGYskaJO4IS1G+i83igFHw/Kjm37sE5wVx/mvHvTrdc9XRsnfaMbzQTT3HHRXV+K3g+B5Gq/lnAm4cxAIqXOyYNZufYNR7PjFIqTH2oKOtWLcEvl2G5d3717J4sfihfxhi6ZYM4tEe6yUuwKZ67HMwlnFgBnSkTc69ss9WrdQ+ze9eV7UvUx+jAfaUwPWVSDeoOEuZVRtyqpYlVcyL4byiSjqH+MZxLOTA1nSgRH+MO97XxAahMHtrcAvK2x10kkqKphDTy90syD0mvVNonc5yIUyopnEs7MC2dKRMfq3CtSRMza9e1Ybwjuohsf7bo7FAe9UGV0jCHmxHGTeM78u3jW4hke10nCmWY4I3EInn618VoaCepwFJwpEQkp/q28BwrRkZLQ2NZ+T1QjqU/x2VO/Mqq08dPXJM483U/hjAPPLBXOqHacro8oOHPjxvFu/0atLHBmfpHis0Z3tXsjj9jxKTreDq1xKKwqI47nmC/q1m68ZeZBT048szw4w3O4TqyBM1hHOIM9McSt/8KZFCmTlbU58kq+p9wy5k2VMbRo+jVNuz66CrQfzywDzthUg+imC5yRa32t6Vl3gzMlIlNw3iBSr7t29zTDFeDDkcIRf6194uQAONOGZ+aHM5Wq0Qpn9FrmoyecKRHjMp42iNQTfZphk6rsmSxfC08D4q553Kq9a+l+UHx2zKXazE7ejGfmhzM2YqCHG85gx/VBq8KZ8URKuzxXbXTPcJ3AVbs03RM/Usafz1IlddfymRNS20mFquN0cjiDvXCU2gNn/O1BNzhTooa0uYr1IWCclDg/j7uqx4pONWpi9HhlHZUTME9i4SLFZ6eGM4o1Kw8PnNGQrf5QOBMvUv6xQvVh1InmFAPuB6+2pwl5uC0dTAbvORyP+ufoXUobbpc2VcMUqVnhjF84PHDmpz/kEleNnqI7lcIrjhqUxaANIfi0YF3uoUUTqUYyVCR6zxJVHP6C/UIzcz0NdVvxzOhwJl444q/VDc6UoLF2Es0+xfFsMdSbUnQL2aApFKpTseteK36y6RRvltiNO3Sn2ymXBX7zNveFBps024pnJocz7qyvA864ozaFM8Ei1a5T2JvdpfyrlN/xsWCF0icu/syw/V0OrArVTnwknkL4viOL3En7danuOraYa13r1bxUsAEVyg9n/Hhmejjj7+164AxaWn+hnnCmhKcPNka0cFbKxebAaWgK1WiOHFkStz8TvDARiUWISB5RvfQeuiiUhkjiSyJVXOvLxjgnyNKyEw110UQtGoW6WJtOVZc2QGrn4BbvqB/mhzPYSWU2hcMJZ6hTvg41D3l0kdL+CCrw8OHDcp0dHR3x89mzZ6t40+eus6jUqGR89yG+JGXcYVz35cuX7ROddFm77aKJM/DSgvaSURjixzPzwxnsrLLsTjhTH0x1hjNlb+src8fUDE4wuuKcY+4V/9rDHLkTahX3EBpIUqW4CuenG0O4dQKqhv0di8aD1dLx63LXLPfgmQXBGeyNffzBzZtOOFPZHvA2A5wZSqTUUZ15x/lbe6pFbu0ZlvSswzPLgzMUyiYcrXCGkhH8GWbt9YczZa+Oas87zm+Ir3xbxtWdcmtPr05Z8cxS4QwyTdl3S/PlP+yd0W3cOhBFJ/61gff+/elCnBJeGy7CQDpIOkgr7mxzIUID5G02GY7IJamci0WwseUlxeUdUnNEyqwVnJE+394BtRecsQFG7bbJ6bR7S0dPHyWn6gE8c3Y4ozPdTvljf+l9Lzjj7byX0hfO2HCjrj+ZyscdP30mU8AZ4Mwt2SRG9YNPOY1iMgWcAc6kZQOMeurZhHtGvaSuucpqYQScAc78LBtg1FPPJjIDly+LL/fOIOAMcEbaZQOMeuqe5A9xSaybZTIFnAHOXMumMqqacunn63qskXOSkb3ctYyAM8CZXTaVUX0jt9W7jlogfdeyFgNfEHAGOLPLZjOqZhMrpmacenjXySFe/a2VRU8IOAOc2WSzGVXhyWcT67LwI5/AKhngDHBGctlsRvXZhL6ARTGT3hwJ8dzYCZwBzkguG2XUaW/rGD4J0mjPvQjAGeCMyyY0auAW4VXyI/kuqOXyFwScAc4oSM1pVHU+H+5OgJnSj2tXk/rumvpXfUsLVkmrA2f+Kjhjo4waH+6ujap9MMY2sb7pj02qhtfW+02rdR7Pz892Q2qEhToZcAY4c0Q2rVFFIl5eXnTVM4NR/bkJ1/VRFvbp6anhvE8Fvb29+eJyXyaqnyteK2Hny9BVn8sKAs4AZ47IpjWq9uKZx6i+aZFX6XWT3rQNmvqE0rxykQr9zY4Z4admjRdwBjhzRJY3qtmrXtubExvVt3wtneMai7y/v5vZ4+NjCdZ+QG6I880b9T5yzbJE5g44A5w5Iqs26q+eQi+bSrLp+YyqakQqoyYq5kkPUP4Qkfg2ryqoNLgsx13mwJmzwhmrMKpO6U873cumZzKqLgq8MvHJZvqhj15WrdNUTxbrtYUzMipwZpJQZVGjhp8cpFM/h1H1DSVORNUoHV2nkLg1sbZb+FZBl4kFnJkVznjm5qtSfPtMQ3NV9eGJ4IxFjVr5wPnVjeq3vSkC9h7tPbTp35zTJgdV88OZuFH7w5nrrG8vOPPp0z/qp7evi2aBMxYyauqZ80sb1WONRu804u29XtSnn/chNRi1M5wJZH2b5Xwj+Ru9poAzFjJqfZDS2a9uVM8spoNm/Okgtilt7Lut7Meo3eBMMOvbBM5U5W++b9c3I+GMhYyqyta/1AwrGLV/ffqXdc+xDqM2hzOVlTkKZ7ys8GswnLGQeVIvteW6RvWZnfpluuepVvFLy0S387/1weA+wqhN4Uwi65uHMwq26tSVVh4MZyxkVK9vZUMubVRfe9E7n+VlKcime/nljsKoTeFMLuubhDNqt5SbR8IZCxlV1Uy14spGzW+QpuN93Ubinp35F4ti1KZwJpf1zcGZdPJmJJyxkFFrZsaeOVjdqH4Hlp7ln7j2VP9LXF16jI632JBtNzBqMziTr08CzqSTNyPhjEWNmjin9Y2qz1Q3cgIdJ0feexInok+IFzSq62DUhPrVp39ZI+GMVRi1ZoD79+FhdaN6EfE7ZXRwIUea1qXzxzqjPw7XOkCHDbzQw6jt4Ew665uAM+nBYCScsTqjxiKUbHomoyp0KkyXVeNqit/cJ+1Lo/XfdLbeb1n8ZVnqKPqVSUMjFEZtB2fSWd8EnJG+1hc0GM5YtVH1Dd/OQ33bEljnM6qqUbxUQpVWn37s0ntNsqyoBaX2pi4ZOmXEvmzyFbCSDhi7lz5GbQdnclnfJJxRn6o/98FwxpJGNfti9rG/9F42Pb1RNWJ7ra6lUbrJMOu7ZXlrSy79UL8auwsSRm0NZxJZ3yScqY/R4+GMYdREAFXpr7sUkX3j0OYq2/2oOEnlTrKKGKN2gDN1Wd+Hhzycqbng1WHj4YxhVFQrjNoHzsSzvkfhzHZG3wOLgaaAM3ZBqEYYtSeciWR9W8EZ6fONsnQB/lPOlyCFEEb1nO+trG8vOLOF+/9UxF7K/3O+BCmEMCo5X4IUOiyMCpwhSCGEURFBCiFEkEIIIYIUQogghRBCBCmEECJIIYQIUgghRJBCCBGkEEKIIIUQQgQp9KOdOhYAAAAAGORvPY0dBRFICkBSgKQAtgJgnlAB3nhbIQAAAABJRU5ErkJggg==" width="640"/><div class="markdown"><h3 id="选择性子树渲染"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#选择性子树渲染"><span class="icon icon-link"></span></a>选择性子树渲染</h3><p>最后，你还有可能去掉一些子树的重新渲染。如果你在 component 上实现以下方法的话：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">boolean </span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token plain">object nextProps</span><span class="token punctuation">,</span><span class="token plain"> object nextState</span><span class="token punctuation">)</span></div></pre></div><p>根据 component 的前一个和下一个 <code>props/state</code>，你可以告诉 React 这个 component 没有更新，也不需要重新绘制，实现得好的话，可以带来巨大的性能提升。</p><p>要用这个方法，你要能够对 JavaScript Object 进行比对，这样有很多细节的因素，比如对比应该是深度的还是浅层的。如果要深的，我们是用不可变数结构，还是进行深度拷贝。</p><p>而且你要注意，这个函数每次都会被调用，所以你要确保运行起来花的时间更少，比 React 的做法时间少，还有比计算 component 需要的时间少，即使重新绘制并不是必要的。</p></div><img alt="选择性子树渲染" src="data:image/png;base64,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" width="640"/><div class="markdown"><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#总结"><span class="icon icon-link"></span></a>总结</h2><ul><li>React 通过制定大胆的 diff 策略，将 <em>O(n^3)</em> 复杂度的问题转换成 <em>O(n)</em> 复杂度的问题</li><li>React 通过分层求异的策略，对 tree diff 进行算法优化</li><li>React 通过相同类生成相似树形结构，不同类生成不同树形结构的策略，对 component diff 进行算法优化</li><li>React 通过设置唯一 key 的策略，对 element diff 进行算法优化</li><li>建议，在开发过程中，保持稳定的 DOM 结构会有助于性能的提升</li><li>建议，在开发过程中，尽量减少类似将最后一个节点移动到列表首部的操作，当节点数量过大或更新操作过于频繁时，在一定程度上会影响 React 的渲染性能</li></ul><h2 id="结论"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/diffing-algorithm#结论"><span class="icon icon-link"></span></a>结论</h2><p>帮助 React 变快的技术并不新颖，长久以来，我们知道触碰 DOM 是费时的，你应该合并处理读和写的操作，事件代理会更快。</p><p>人们还是会经常讨论他们，因为在实际当中用 JavaScript 进行实现还是挺难的，React 突出的一个原因是这些优化默认就启动了，这就让你避免掉不小心把 App 写得很慢。</p><p>React 消耗性能的模型很简单，很好理解：每次调用 <code>setState</code> 会重新计算整个子树。如果你想要提高性能，尽量少调用 <code>setState</code>，还有用 <code>shouldComponentUpdate</code> 减少大的子树的重新计算。</p><p>总结一下 Diff 算法的大致流程：</p><ol><li>又一个全局变量 updateDepth 来标识递归的深度，进行 diff 算法之前 +1，diff 算法结束之后 -1。当其重新变为 0 的时候表示整个 diff 算法结束了，可以拿更新队列 diffQueue 来更新 DOM 了</li><li>Diff 算法只对同个父元素的同级子元素进行对比。如果元素的 type 和 key（如果有的话）相同，视为同一个元素，进行更新；否则替换掉。</li><li>Diff 使用了一个局部变量：<code>lastIndex</code> ——记录已经处理的就列表中最靠后的元素。当元素的 <code>._mountIndex</code> 大于 <code>lastIndex</code> 的时候，不需要移动元素。因为移动元素不会对前面对元素产生任何影响，因此可以省略这个动作，由于很多时候大部分元素处于这种情况下，因此这个局部变量提升了性能（有时候很明显）。 需要注意的是如果把列表中最后一个元素移到最前面，那么 <code>lastIndex</code> 就会大于后面对比的所有元素，导致的后果就是列表中所有元素都将被移动。</li></ol><hr/><p><strong>参考资料：</strong></p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://zhuanlan.zhihu.com/p/20346379">📝 React 源码剖析系列——不可思议的 react diff<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://blog.csdn.net/qq_26708777/article/details/78107577?utm_source=blogxgwz6">📝 React Diff 算法浅析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://segmentfault.com/a/1190000000606216">📝 React 的 diff 算法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/5aa163df518825557b4c4f0a">📝 React 源码分析——Diff 算法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://www.bilibili.com/video/av41341063?from=search&amp;seid=4225014166530473905">📝 Virtual DOM 的原理与实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://segmentfault.com/a/1190000016539430">📝 谈谈 React 中 Diff 算法的策略及实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://segmentfault.com/a/1190000017039293">📝 React 源码深度解读：Diff 算法详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://www.ctolib.com/topics-134765.html">📝 从 React 渲染流程分析 Diff 算法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook/edit/master/docs/infrastructure/old/diffing-algorithm.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2023/7/9 17:25:56</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/black-react-guidebook/umi.f5521da1.js"></script>
  </body>
</html>
