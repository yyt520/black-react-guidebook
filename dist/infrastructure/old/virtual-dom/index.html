<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/black-react-guidebook/umi.b283d7b5.css" />
    <script>
      window.routerBase = "/black-react-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.20
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>Virtual DOM</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/infrastructure/old/virtual-dom" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/black-react-guidebook//">React Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/black-react-guidebook//foundation">基础</a></span><span><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure">架构</a></span><span><a href="/black-react-guidebook//ecosystem">生态</a></span><span><a href="/black-react-guidebook//api-reference">API</a></span><span><a href="/black-react-guidebook//extensions">扩展</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/react-guidebook-favicon.png&#x27;)" href="/black-react-guidebook//"></a><h1>React Guidebook</h1><p>React 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/black-react-guidebook//foundation">基础</a></li><li><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure">架构</a></li><li><a href="/black-react-guidebook//ecosystem">生态</a></li><li><a href="/black-react-guidebook//api-reference">API</a></li><li><a href="/black-react-guidebook//extensions">扩展</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">新版架构</a><ul><li><a href="/black-react-guidebook//infrastructure/new/fiber"><span>Fiber</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/reconciliation"><span>Reconciliation</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/concurrent"><span>Concurrent</span></a></li><li><a href="/black-react-guidebook//infrastructure/new/scheduler"><span>Scheduler</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">Hooks</a><ul><li><a href="/black-react-guidebook//infrastructure/hooks"><span>Hooks</span></a></li><li><a href="/black-react-guidebook//infrastructure/hooks/hooks-analysis"><span>源码分析</span></a></li><li><a href="/black-react-guidebook//infrastructure/hooks/use-state"><span>useState</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">旧版架构</a><ul><li><a aria-current="page" class="active" href="/black-react-guidebook//infrastructure/old/virtual-dom"><span>Virtual DOM</span></a></li><li><a href="/black-react-guidebook//infrastructure/old/diffing-algorithm"><span>DOM DIFF 算法</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="基本原理" data-depth="2"><a href="/black-react-guidebook//infrastructure/old/virtual-dom#基本原理"><span>基本原理</span></a></li><li title="算法实现" data-depth="2"><a href="/black-react-guidebook//infrastructure/old/virtual-dom#算法实现"><span>算法实现</span></a></li><li title="模拟 DOM 树" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/virtual-dom#模拟-dom-树"><span>模拟 DOM 树</span></a></li><li title="判断差异" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/virtual-dom#判断差异"><span>判断差异</span></a></li><li title="算法实现总结" data-depth="3"><a href="/black-react-guidebook//infrastructure/old/virtual-dom#算法实现总结"><span>算法实现总结</span></a></li><li title="特点" data-depth="2"><a href="/black-react-guidebook//infrastructure/old/virtual-dom#特点"><span>特点</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="virtual-dom"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#virtual-dom"><span class="icon icon-link"></span></a>Virtual DOM</h1><blockquote><p>Virtual DOM 的本质是一个用来映射真实 DOM 的 JavaScript 对象</p></blockquote><p>React 的 Virtual DOM，是存储于内存中的 JavaScript 对象，React 先将页面发生的变化更新到 Virtual DOM，每次的变化都和上次 Virtual DOM 的状态进行比较，找到变化的部分，最终 React 先将包含了所有变化的 Virtual DOM 与真实 DOM 进行比较，找到 DOM 发生变化的部分，一次性应用到真实 DOM 上。这样能有效减少浏览器的回流和重绘，以最少的代价渲染 DOM，实现最小化性能对资源池的操作，从而提高页面渲染速度与性能。</p><h2 id="基本原理"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#基本原理"><span class="icon icon-link"></span></a>基本原理</h2><p>虚拟的 DOM 的核心思想是：对复杂的文档 DOM 结构，提供一种方便的工具，进行最小化地 DOM 操作。这句话，也许过于抽象，却基本概况了虚拟 DOM 的设计思想。</p><p>使用 JavaScript 对象表示 DOM 信息和结构，当状态变更的时候，会重新渲染这个 JavaScript 的对象结构。</p><p><strong>DOM 树的 JavaScript 对象表达</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 节点标签名</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  tagName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;ul&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// DOM属性,用一个对象存储键值对</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;list&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 该节点的子节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  children</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> tagName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">,</span><span class="token plain"> props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;item&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> children</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Item 1&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> tagName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">,</span><span class="token plain"> props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;item&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> children</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Item 2&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> tagName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">,</span><span class="token plain"> props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;item&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> children</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Item 3&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>对应的 DOM 树中的 HTML 写法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag">ul</span><span class="token tag"> </span><span class="token tag attr-name">id</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">list</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token tag punctuation">&lt;</span><span class="token tag">li</span><span class="token tag"> </span><span class="token tag attr-name">class</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">item</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">Item1</span><span class="token tag punctuation">&lt;/</span><span class="token tag">li</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token tag punctuation">&lt;</span><span class="token tag">li</span><span class="token tag"> </span><span class="token tag attr-name">class</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">item</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">Item2</span><span class="token tag punctuation">&lt;/</span><span class="token tag">li</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token tag punctuation">&lt;</span><span class="token tag">li</span><span class="token tag"> </span><span class="token tag attr-name">class</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">item</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">Item3</span><span class="token tag punctuation">&lt;/</span><span class="token tag">li</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">ul</span><span class="token tag punctuation">&gt;</span></div></pre></div><p>反之亦然，你亦可以根据 JavaScript 对象来构建真正的 DOM 树。</p><h2 id="算法实现"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#算法实现"><span class="icon icon-link"></span></a>算法实现</h2><p><strong>算法实现步骤：</strong></p><ol><li>用 JavaScript 对象结构表示 DOM 树的结构；然后用这个树构建一个真正的 DOM 树，插到文档当中</li><li>当状态变更的时候，重新构造一棵新的对象树。然后用新的树和旧的树进行比较，记录两棵树差异</li><li>把步骤 2 所记录的差异应用到步骤 1 所构建的真正的 DOM 树上，视图就更新了</li></ol><p><strong>功能拆分（React 中实际方法函数）</strong></p><ol><li>一个生成虚拟 DOM 对象的 Javascript 函数（React.createElement）</li><li>一个将虚拟 DOM 转换成真实 DOM 的函数</li><li>一个解析模版节点的函数</li><li>一个更新虚拟 DOM 新旧节点的函数</li><li>一个对比虚拟 DOM 新旧节点的函数</li></ol><h3 id="模拟-dom-树"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#模拟-dom-树"><span class="icon icon-link"></span></a>模拟 DOM 树</h3><p>用 JavaScript 来表示一个 DOM 节点是很简单的事情，你只需要记录它的<strong>节点类型</strong>、<strong>属性</strong>，还有<strong>子节点</strong>：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// element.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Element</span><span class="token punctuation">(</span><span class="token parameter">tagName</span><span class="token parameter punctuation">,</span><span class="token parameter"> props</span><span class="token parameter punctuation">,</span><span class="token parameter"> children</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">tagName</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> tagName</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> children</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">tagName</span><span class="token parameter punctuation">,</span><span class="token parameter"> props</span><span class="token parameter punctuation">,</span><span class="token parameter"> children</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Element</span><span class="token punctuation">(</span><span class="token plain">tagName</span><span class="token punctuation">,</span><span class="token plain"> props</span><span class="token punctuation">,</span><span class="token plain"> children</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p>例如上面的 DOM 结构就可以简单的表示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> el </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./element&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> ul </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;ul&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;list&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;item&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Item 1&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;item&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Item 2&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;item&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Item 3&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>现在 <code>ul</code> 只是一个 JavaScript 对象表示的 DOM 结构，页面上并没有这个结构。我们可以根据这个 <code>ul</code> 构建真正的 <code>&lt;ul&gt;</code> 标签：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token class-name">Element</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 根据 tagName 构建</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> el </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">creatElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">tagName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> props </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 设置节点的 DOM 属性</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">var</span><span class="token plain"> propName </span><span class="token keyword">in</span><span class="token plain"> props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> propValue </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">[</span><span class="token plain">propName</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    el</span><span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span><span class="token plain">propName</span><span class="token punctuation">,</span><span class="token plain"> propValue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> children </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  children</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果子节点也是虚拟 DOM，则递归构建 DOM 节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> childEl </span><span class="token operator">=</span><span class="token plain"> child </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Element</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> child</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span><span class="token plain">child</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 如果字符串,只构建文本节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    el</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">childEl</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> el</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p><code>render()</code> 方法会根据 <code>tagName</code> 构建一个真正的 DOM 节点，然后设置这个节点的属性，最后递归地把自己的子节点也构建起来。所以只需要：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> ulRoot </span><span class="token operator">=</span><span class="token plain"> ul</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">ulRoot</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p><code>ulRoot</code> 是真正的 DOM 节点，把它塞入文档中，这样的 <code>&lt;body&gt;</code> 里面就有了真正的 <code>&lt;ul&gt;</code> 的 DOM 结构。</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag">ul</span><span class="token tag"> </span><span class="token tag attr-name">id</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">list</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token tag punctuation">&lt;</span><span class="token tag">li</span><span class="token tag"> </span><span class="token tag attr-name">class</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">item</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">Item1</span><span class="token tag punctuation">&lt;/</span><span class="token tag">li</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token tag punctuation">&lt;</span><span class="token tag">li</span><span class="token tag"> </span><span class="token tag attr-name">class</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">item</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">Item2</span><span class="token tag punctuation">&lt;/</span><span class="token tag">li</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token tag punctuation">&lt;</span><span class="token tag">li</span><span class="token tag"> </span><span class="token tag attr-name">class</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">item</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">Item3</span><span class="token tag punctuation">&lt;/</span><span class="token tag">li</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">ul</span><span class="token tag punctuation">&gt;</span></div></pre></div><p>完整代码可见 <a target="_blank" rel="noopener noreferrer" href="https://github.com/livoras/simple-virtual-dom/blob/master/lib/element.js">element.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h3 id="判断差异"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#判断差异"><span class="icon icon-link"></span></a>判断差异</h3><p>既然我们已经通过 JavaScript 来模拟实现了 DOM，那么接下来的难点就在于<strong>如何判断旧的对象和新的对象之间的差异</strong>。</p><p>DOM 是多叉树的结构，如果需要完整的对比两棵树的差异，那么需要的时间复杂度会是 <code>O(n^3)</code>，这个复杂度肯定是不能接受的。于是 React 团队优化了算法，实现了 <code>O(n)</code> 的复杂度来对比差异。</p><p>实现 <code>O(n)</code> 复杂度的关键就是只对比同层的节点，而不是跨层对比，这也是考虑到在实际业务中很少会去跨层的移动 DOM 元素。</p><p>所以判断差异的算法就分为了两步：</p><ul><li>首先<strong>从上至下</strong>，<strong>从左往右</strong>遍历对象，也就是<span style="color:red;font-weight:bold">树的深度优先遍历</span>，这一步中会给<strong>每个节点添加索引</strong>，便于最后渲染差异（同层节点进行比较的常用方法）</li><li>一旦节点有子元素，就去判断子元素是否有不同</li></ul></div><img alt="VirtualDOM：同层级元素比对" src="/black-react-guidebook/static/virtual_dom_1.5199f607.jpg" width="640"/><div class="markdown"></div><img alt="深度优先遍历，记录差异" src="/black-react-guidebook/static/virtual_dom_2.9762b96d.jpg" width="640"/><div class="markdown"><h4 id="树的递归"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#树的递归"><span class="icon icon-link"></span></a>树的递归</h4><p>首先我们来实现树的递归算法，在实现该算法前，先来考虑下两个节点对比会有几种情况</p><ol><li>新的节点的 <code>tagName</code> 或者 <code>key</code> 和旧的节点不同，这种情况代表需要替换旧的节点，并且也不再需要遍历新旧节点的子元素了，因为整个旧节点都被删掉了</li><li>新的节点的 <code>tagName</code> 和 <code>key</code>（可能都没有）和旧的节点相同，开始遍历子树</li><li>没有新的节点，那么什么都不用做</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"> stateEnums</span><span class="token imports punctuation">,</span><span class="token imports"> isString</span><span class="token imports punctuation">,</span><span class="token imports"> move </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./util&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Element</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;./element&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">olaDOMTree</span><span class="token parameter punctuation">,</span><span class="token parameter"> newDOMTree</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 用于记录差异</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> patches </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 一开始的索引为 0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token plain">oldDOMTree</span><span class="token punctuation">,</span><span class="token plain"> newDOMTree</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> patches</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> patches</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token parameter">oldNode</span><span class="token parameter punctuation">,</span><span class="token parameter"> newNode</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token parameter punctuation">,</span><span class="token parameter"> patches</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 用于保存子树的更改</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> currentPatches </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 需要判断三种情况</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 1. 没有新的节点，那么什么都不做</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 2. 新的节点的 tagName 和 key 和旧的节点不同，就替换</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 3. 新的节点的 tagName 和 key（可能都没有）和旧的节点相同，开始遍历子树</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">newNode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">newNode </span><span class="token operator">&amp;&amp;</span><span class="token plain"> newNode</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> oldNode</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> newNode</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> oldNode</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 判断属性是否变更</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> props </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token plain">oldNode</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"> newNode</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      currentPatches</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">ChangeProps</span><span class="token punctuation">,</span><span class="token plain"> props </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">diffChildren</span><span class="token punctuation">(</span><span class="token plain">oldNode</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">,</span><span class="token plain"> newNode</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"> patches</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 节点不同，需要替换</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    currentPatches</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Replace</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token operator">:</span><span class="token plain"> newNode </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">currentPathces</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">patches</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      patches</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> patches</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token plain">currentPathces</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      patches</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> currentPatches</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h4 id="判断属性的更改"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#判断属性的更改"><span class="icon icon-link"></span></a>判断属性的更改</h4><p>判断属性的更改也分为三个步骤：</p><ol><li>遍历旧的属性列表，查看每个属性<strong>是否还存在于新的属性列表</strong>中</li><li>遍历新的属性列表，判断两个列表中<strong>都存在的属性的值是否有变化</strong></li><li>在第二步中同时查看是否有属性不存在于旧的属性列表中</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">diffProps</span><span class="token punctuation">(</span><span class="token parameter">oldProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">		</span><span class="token comment">// 判断 Props 分以下三步骤</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  	</span><span class="token comment">// 先遍历 oldProps 查看是否存在删除的属性</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  	</span><span class="token comment">// 然后遍历 newProps 查看是否有属性值被修改</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  	</span><span class="token comment">// 最后查看是否有属性新增</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> change </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">const</span><span class="token plain"> key </span><span class="token keyword">in</span><span class="token plain"> oldProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">oldProps</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">newProps</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            change</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                prop</span><span class="token operator">:</span><span class="token plain"> keyd</span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">const</span><span class="token plain"> key </span><span class="token keyword">in</span><span class="token plain"> newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">oldProps</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">const</span><span class="token plain"> prop </span><span class="token operator">=</span><span class="token plain"> newProps</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">oldProps</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> oldProps</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> newProps</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                change</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    props</span><span class="token operator">:</span><span class="token plain"> key</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    value</span><span class="token operator">:</span><span class="token plain"> newProps</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">oldProps</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                change</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    prop</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    value</span><span class="token operator">:</span><span class="token plain"> newProps</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> change</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h4 id="判断列表差异算法实现"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#判断列表差异算法实现"><span class="icon icon-link"></span></a>判断列表差异算法实现</h4><p>这个算法是整个 Virtual Dom 中最核心的算法。 这里的主要步骤其实和判断属性差异是类似的，也是分为三步：</p><ol><li>遍历旧的节点列表，查看每个节点是否还存在于新的节点列表中</li><li>遍历新的节点列表，判断是否有新的节点</li><li>在第二步中同时判断节点是否有移动</li></ol><p>⚠️ <strong>注意</strong>：该算法只对有 <code>key</code> 的节点做处理</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">listDiff</span><span class="token punctuation">(</span><span class="token parameter">oldList</span><span class="token parameter punctuation">,</span><span class="token parameter"> newList</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token parameter punctuation">,</span><span class="token parameter"> patches</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 为了遍历方便，先取出两个 list 的所有 keys</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> oldKeys </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token plain">oldList</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> newKeys </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token plain">newList</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> changes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 用于保存变更后的节点数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 使用该数组保存有以下好处</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 1.可以正确获得被删除节点索引</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 2.交换节点位置只需要操作一遍 DOM</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 3.用于 `diffChildren` 函数中的判断，只需要遍历</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 两个树中都存在的节点，而对于新增或者删除的节点来说，完全没必要</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 再去判断一遍</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> list </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  oldList </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    oldList</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> key </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        key </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 寻找新的 children 中是否含有当前节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 没有的话需要删除</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> newKeys</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        list</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> list</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 遍历变更后的数组</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> length </span><span class="token operator">=</span><span class="token plain"> list</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 因为删除数组元素是会更改索引的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 所有从后往前删可以保证索引不变</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> length </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">--</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 判断当前元素是否为空，为空表示需要删除</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">list</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      list</span><span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      changes</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Remove</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        index</span><span class="token operator">:</span><span class="token plain"> i</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 遍历新的 list，判断是否有节点新增或移动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 同时也对 `list` 做节点新增和移动节点的操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  newList </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    newList</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token parameter punctuation">,</span><span class="token parameter"> i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> key </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        key </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 寻找旧的 children 中是否含有当前节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> list</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 没找到代表新节点，需要插入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> key </span><span class="token operator">==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        changes</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Insert</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          node</span><span class="token operator">:</span><span class="token plain"> item</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          index</span><span class="token operator">:</span><span class="token plain"> i</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        list</span><span class="token punctuation">.</span><span class="token method function property-access">splice</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 找到了，需要判断是否需要移动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">!==</span><span class="token plain"> i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          changes</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Move</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword module">from</span><span class="token operator">:</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            to</span><span class="token operator">:</span><span class="token plain"> i</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">move</span><span class="token punctuation">(</span><span class="token plain">list</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"> i</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> changes</span><span class="token punctuation">,</span><span class="token plain"> list </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> keys </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> text</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  list </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    list</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> key</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        key </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">item</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">item </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        key </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      keys</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> keys</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h4 id="遍历子元素打标识"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#遍历子元素打标识"><span class="icon icon-link"></span></a>遍历子元素打标识</h4><p>对于这个函数来说，主要功能就两个</p><ol><li>判断两个列表差异</li><li>给节点打上标记</li></ol><p>总体来说，该函数实现的功能很简单</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">diffChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChild</span><span class="token parameter punctuation">,</span><span class="token parameter"> newChild</span><span class="token parameter punctuation">,</span><span class="token parameter"> index</span><span class="token parameter punctuation">,</span><span class="token parameter"> patches</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> changes</span><span class="token punctuation">,</span><span class="token plain"> list </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">listDiff</span><span class="token punctuation">(</span><span class="token plain">oldChild</span><span class="token punctuation">,</span><span class="token plain"> newChild</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"> patches</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">changes</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">patches</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      patches</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> patches</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token plain">changes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      patches</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> changes</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 记录上一个遍历过的节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> last </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  oldChild </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    oldChild</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token parameter punctuation">,</span><span class="token parameter"> i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> child </span><span class="token operator">=</span><span class="token plain"> item </span><span class="token operator">&amp;&amp;</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">child</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        index </span><span class="token operator">=</span><span class="token plain"> last </span><span class="token operator">&amp;&amp;</span><span class="token plain"> last</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> index </span><span class="token operator">+</span><span class="token plain"> last</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> index </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> keyIndex </span><span class="token operator">=</span><span class="token plain"> list</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> node </span><span class="token operator">=</span><span class="token plain"> newChild</span><span class="token punctuation">[</span><span class="token plain">keyIndex</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 只遍历新旧中都存在的节点，其他新增或者删除的没必要遍历</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">dfs</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token punctuation">,</span><span class="token plain"> index</span><span class="token punctuation">,</span><span class="token plain"> patches</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> index </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      last </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h4 id="渲染差异"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#渲染差异"><span class="icon icon-link"></span></a>渲染差异</h4><p>通过之前的算法，我们已经可以得出两个树的差异了。既然知道了差异，就需要局部去更新 DOM 了，下面就让我们来看看 Virtual DOM 算法的最后一步骤：</p><p>这个函数主要两个功能</p><ol><li>深度遍历树，将需要做变更操作的取出来</li><li>局部更新 DOM</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token parameter punctuation">,</span><span class="token parameter"> patchs</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> changes </span><span class="token operator">=</span><span class="token plain"> patchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> childNodes </span><span class="token operator">=</span><span class="token plain"> node </span><span class="token operator">&amp;&amp;</span><span class="token plain"> node</span><span class="token punctuation">.</span><span class="token property-access">childNodes</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 这里的深度遍历和 diff 中是一样的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">childNodes</span><span class="token punctuation">)</span><span class="token plain"> index </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">changes </span><span class="token operator">&amp;&amp;</span><span class="token plain"> changes</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> patchs</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">changeDom</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">,</span><span class="token plain"> changes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> last </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">childNodes </span><span class="token operator">&amp;&amp;</span><span class="token plain"> childNodes</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    childNodes</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token parameter punctuation">,</span><span class="token parameter"> i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      index </span><span class="token operator">=</span><span class="token plain"> last </span><span class="token operator">&amp;&amp;</span><span class="token plain"> last</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> index </span><span class="token operator">+</span><span class="token plain"> last</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> index </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">,</span><span class="token plain"> patchs</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      last </span><span class="token operator">=</span><span class="token plain"> item</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">changeDom</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token parameter punctuation">,</span><span class="token parameter"> changes</span><span class="token parameter punctuation">,</span><span class="token parameter"> noChild</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  changes </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    changes</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">change</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> type </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> change</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">ChangeProps</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> props </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> change</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          props</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              node</span><span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">.</span><span class="token property-access">prop</span><span class="token punctuation">,</span><span class="token plain"> item</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              node</span><span class="token punctuation">.</span><span class="token method function property-access">removeAttribute</span><span class="token punctuation">(</span><span class="token plain">item</span><span class="token punctuation">.</span><span class="token property-access">prop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Remove</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          node</span><span class="token punctuation">.</span><span class="token property-access">childNodes</span><span class="token punctuation">[</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token property-access">index</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Insert</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> dom</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            dom </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token plain"> </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            dom </span><span class="token operator">=</span><span class="token plain"> change</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          node</span><span class="token punctuation">.</span><span class="token method function property-access">insertBefore</span><span class="token punctuation">(</span><span class="token plain">dom</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token punctuation">.</span><span class="token property-access">childNodes</span><span class="token punctuation">[</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token property-access">index</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Replace</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          node</span><span class="token punctuation">.</span><span class="token property-access">parentNode</span><span class="token punctuation">.</span><span class="token method function property-access">replaceChild</span><span class="token punctuation">(</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> node</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token maybe-class-name">StateEnums</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Move</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> fromNode </span><span class="token operator">=</span><span class="token plain"> node</span><span class="token punctuation">.</span><span class="token property-access">childNodes</span><span class="token punctuation">[</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token keyword module">from</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> toNode </span><span class="token operator">=</span><span class="token plain"> node</span><span class="token punctuation">.</span><span class="token property-access">childNodes</span><span class="token punctuation">[</span><span class="token plain">change</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> cloneFromNode </span><span class="token operator">=</span><span class="token plain"> fromNode</span><span class="token punctuation">.</span><span class="token method function property-access">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> cloenToNode </span><span class="token operator">=</span><span class="token plain"> toNode</span><span class="token punctuation">.</span><span class="token method function property-access">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          node</span><span class="token punctuation">.</span><span class="token method function property-access">replaceChild</span><span class="token punctuation">(</span><span class="token plain">cloneFromNode</span><span class="token punctuation">,</span><span class="token plain"> toNode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          node</span><span class="token punctuation">.</span><span class="token method function property-access">replaceChild</span><span class="token punctuation">(</span><span class="token plain">cloenToNode</span><span class="token punctuation">,</span><span class="token plain"> fromNode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="算法实现总结"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#算法实现总结"><span class="icon icon-link"></span></a>算法实现总结</h3><p>Virtual DOM 算法主要是实现上面步骤的三个函数：<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/livoras/simple-virtual-dom/blob/master/lib/element.js">element<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/livoras/simple-virtual-dom/blob/master/lib/diff.js">diff<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a target="_blank" rel="noopener noreferrer" href="https://link.zhihu.com/?target=https%3A//github.com/livoras/simple-virtual-dom/blob/master/lib/patch.js">patch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。然后就可以实际的进行使用：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// 1. 构建虚拟DOM</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> tree </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;div&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;container&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;h1&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> style</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;color: blue&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;simple virtal dom&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;p&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Hello, virtual-dom&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;ul&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 2. 通过虚拟 DOM 构建真正的 DOM</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> tree</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 3. 生成新的虚拟 DOM</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> newTree </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;div&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;container&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;h1&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> style</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;color: red&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;simple virtal dom&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;p&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Hello, virtual-dom&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;ul&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token function">el</span><span class="token punctuation">(</span><span class="token string">&#x27;li&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 4. 比较两棵虚拟DOM树的不同</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> patches </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">diff</span><span class="token punctuation">(</span><span class="token plain">tree</span><span class="token punctuation">,</span><span class="token plain"> newTree</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 5. 在真正的DOM元素上应用变更</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> patches</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><h2 id="特点"><a aria-hidden="true" tabindex="-1" href="/black-react-guidebook//infrastructure/old/virtual-dom#特点"><span class="icon icon-link"></span></a>特点</h2><p>优点：最终表现在 DOM 上的修改只是变更的部分，可以保证非常高效的渲染。</p><p>缺点：首次渲染大量 DOM 时，由于多了一层虚拟 DOM 的计算，会比 innerHTML 插入慢。</p><p>一些轻量级 Virtual DOM 的实现：</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/HolyZheng/holyZheng-blog/issues/14">hoz<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="http://ewind.us/2017/nano-vdom/">Yifeng Wang<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><hr/><p><strong>参考资料：</strong></p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://reactjs.org/docs/faq-internals.html">Virtual DOM and Internals<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://www.zhihu.com/question/29504639?sort=created">知乎：如何理解虚拟 DOM?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/entry/5857482a61ff4b0063c80d4d">掘金：深入研究 Virtual DOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/5b10dd36e51d4506e04cf802#heading-3">掘金：深入框架本源系列<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://sq.163yun.com/blog/article/183677505940332544">网易云：从零开始创建 VirtualDOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://calendar.perfplanet.com/2013/diff/">React‘s diff algorithm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://medium.com/@rajaraodv/the-inner-workings-of-virtual-dom-666ee7ad47cf">The Inner Working Of Virtual DOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-react-guidebook/edit/master/docs/infrastructure/old/virtual-dom.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2023/7/9 17:25:56</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/black-react-guidebook/umi.f5521da1.js"></script>
  </body>
</html>
